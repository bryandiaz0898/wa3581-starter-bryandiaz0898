<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark" />

      
      <meta name="author" content="Ascendient, LLC">
  <!--
  <link rel="stylesheet" href="/app/Course-Build-Tools/assets/themes/ascendient/html/base.css">
  <link rel="stylesheet" href="C:\dev\cw-dev\course-build-tools\assets\themes\ascendient\html\base.css">
  -->
  <link href="https://github.com/googlefonts/noto-emoji/raw/main/fonts/NotoColorEmoji.ttf" rel="stylesheet" media="print">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Mono:wght@100..900&display=swap" rel="stylesheet" media="print">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css" integrity="sha384-zh0CIslj+VczCZtlzBcjt5ppRcsAmDnRem7ESsYwWwg3m/OaJ2l4x7YBZl9Kxxib" crossorigin="anonymous">

  
  <style>
    @page {
      @top-left { content: "WA3581 Advanced Terraform and IaC Workflows"; }
      @top-right { content: "Lab Guide"; }
    }
  </style>
  <style>
    @import url("https://assets.ascendientlearning.com/resources/themes/default/fonts/Ascendient/KareliaWeb-Black.woff2");
@import url("https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap");
@import url("https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css");

:root {
  /*
    Ascendient Digital Palette
    --------------------------
    White - Components BG / Text
    Sand+ - Background / Text
    Dark Sand - Secondary Background
    Warm Sand - Text Color
    Clay - Primary CTA color
    Burgundy - Secondary BG / Text
    Orange - Stylus visuals / Accents
    Smart Blue - Stylus visuals / Accents
  */
  --ascendient-logo: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='#FFF' viewBox='0 0 4176 1618'%3E%3Cpath d='M1035 911v249h-75v-38c-24 29-61 45-107 45-77 0-139-51-139-119s61-110 153-110h88v-33c0-49-15-67-73-67s-75 18-78 69h-80c11-74 75-136 162-136s149 57 149 140Zm-80 128v-40H849c-34 0-50 14-50 39v20c0 31 20 45 71 45 60 0 85-19 85-64Zm120 5h83c3 45 22 58 83 58 55 0 80-14 80-43v-15c0-23-15-32-55-37l-63-5c-70-7-115-47-115-107 0-67 69-124 150-124s148 48 158 122h-83c-2-42-20-56-74-56-49 0-71 12-71 41v13c0 23 14 34 49 37l70 8c71 7 114 46 114 105 0 69-69 126-158 126s-159-50-168-123Zm357-75c0-112 77-198 180-198 88 0 160 64 175 154h-87c-4-61-28-83-89-83s-90 29-90 96v61c0 69 27 98 90 98s85-23 89-84h87c-15 90-87 154-175 154-102 0-180-85-180-198Zm479 23v18c0 64 29 90 96 90 58 0 84-18 88-61h88c-23 73-96 128-175 128-105 0-185-78-185-192s78-204 186-204c99 0 176 85 176 191v30h-274Zm0-70v9h185v-9c0-60-24-84-87-84-68 0-98 25-98 84Zm664 0v238h-82V917c0-51-25-74-83-74-61 0-88 24-88 78v239h-82V779h77v55c29-40 72-63 122-63 78 0 136 64 136 151Zm405-283v521h-77v-52c-27 35-74 59-118 59-95 0-172-88-172-197s78-199 175-199c43 0 82 19 110 52V639h82Zm-82 299c0-67-30-96-99-96s-97 29-97 96v61c0 69 30 98 97 98s99-29 99-98v-61Zm118-258c0-33 24-56 57-56s57 23 57 56-24 56-57 56-57-23-57-56Zm17 99h82v381h-82V779Zm216 213v18c0 64 29 90 96 90 59 0 84-18 88-61h88c-23 73-96 128-175 128-105 0-185-78-185-192s78-204 186-204c99 0 176 85 176 191v30h-274Zm0-70v9h185v-9c0-60-24-84-87-84-68 0-98 25-98 84Zm650 0v238h-82V917c0-51-25-74-83-74-61 0-87 24-87 78v239h-82V779h76v55c29-40 73-63 123-63 77 0 135 64 135 151Zm93 126V847h-80v-68h80V639h81v140h103v68h-103v205c0 25 13 37 38 37h58v75h-54c-75 0-123-45-123-116ZM466 163l147 103L409 4c-2-3-5-4-9-4-2 0-5 1-7 3l-34 29c-5 4-5 11-1 16l108 115Zm-230-14 204 117 100 32 39 13 39 13 17 5-34-24-81-56-80-56L280 80c-3-2-5-3-8-3-5 0-9 3-12 7l-29 45c-4 7-2 16 5 20ZM129 311l322 73 120 2 41 1h45l24 1h6l-5-2-17-5-22-7-7-3-26-8-14-5-79-25-93-31-268-87-5-1c-8 0-15 5-17 12l-17 64c-3 9 3 19 12 21ZM61 538h2l444-33 132-38 40-12 39-11 12-3 23-7 17-5h-36l-32-1-60-1-98-2-98-2-387-7c-12 0-21 9-21 21l2 80c1 12 10 21 21 21Zm5 288 546-213 134-87 35-22 49-32 19-12 32-21-32 9-20 6-19 5-47 13-43 13-18 5-94 27-94 26L18 685c-14 4-21 19-17 32l32 93a26 26 0 0 0 33 16Zm877-380-17 11-17 11-59 38-22 14-34 22-82 53-82 53-564 365a31 31 0 0 0-8 44l70 97a31 31 0 0 0 44 7l875-691-45-62-59 38Zm2037 822h33v269h-33v-269Zm90 181v8c0 39 17 54 57 54 31 0 46-10 49-34h38a97 97 0 0 1-87 64c-54 0-93-41-93-98s40-106 93-106c49 0 88 43 88 98v14h-145Zm0-32v4h108v-5c0-35-14-50-51-50-39 0-57 16-57 51Zm323-8v128h-31v-22a71 71 0 0 1-58 26c-40 0-71-27-71-61s30-55 73-55h54v-18c0-29-10-41-42-41s-45 11-46 41h-34c7-40 39-70 81-70 44 0 74 29 74 72Zm-33 68v-24h-64c-18 0-27 7-27 22v10c0 19 12 26 42 26 34 0 49-10 49-34Zm164-140v42h-31c-26 0-38 12-38 38v120h-33v-196h31v37c15-23 40-37 71-41Zm186 77v123h-33v-126c0-32-15-45-48-45-36 0-51 14-51 46v125h-33v-196h31v29c15-21 37-33 63-33 41 0 71 32 71 77Zm23-123c0-15 11-25 25-25s26 10 26 25-11 25-26 25-25-10-25-25Zm9 50h33v196h-33v-196Zm233 73v123h-33v-126c0-32-15-45-48-45-36 0-51 14-51 46v125h-33v-196h31v29c15-21 37-33 63-33 41 0 71 32 71 77Zm201-73v202c0 41-35 75-86 75s-87-35-88-74h34c0 34 14 45 54 45s53-13 53-50v-38a80 80 0 0 1-61 28c-49 0-86-41-86-96s37-96 87-96c24 0 49 13 62 32v-28h31Zm-33 103v-23c0-38-16-54-55-54s-56 16-56 54v23c0 40 17 57 56 57s55-17 55-57Z'/%3E%3C/svg%3E");
  --white: #ffffff;
  --sand: #faf5ed;
  --warm-sand: #e4c7c2;
  --clay: #5c1726;
  --burgundy: #380a14;
  --bright-orange: #ff6b00;
  --smart-blue: #2e1aa6;
  --sand-plus: #fcf7f2;
  --dark-sand: #f6ebdf;

  /* Sizing */
  --padding-xxl: 10rem;
  --padding-xl: 8rem;
  --padding-lg: 5rem;
  --padding-md: 3rem;
  --padding-sm: 2rem;
  --padding-xs: 1rem;

  --radius-large: 12px; /* Large elements, e.g. background containers */
  --radius-medium: 10px; /* Medium elements, e.g. medium sized cards */
  --radius-small: 8px; /* Small elements, e.g. small cards */
  --radius-xsmall: 4px; /* Extra small elements, e.g. buttons */

  /*
    Ascendient Typography
    ---------------------
    Sizes have been converted to rem units.

    | Element | Name       |
    |---------|------------|
    | H1      | Headline L |
    | H2      | Title L    |
    | H3      | Title M    |
    | H4      | Title S    |
    | H5      | Title XS   |

    | Name       | Face    | Size | Line Height
    |------------|---------|------|------------
    | Headline L | Karelia | 64   | 105%
    | Headline M | Karelia | 60   | 105%
    | Headline S | Karelia | 52   | 105%
    | Title L    | Karelia | 30   | 105%
    | Title M    | Karelia | 22   | 100%
    | Title S    | Karelia | 19   | 115%
    | Title XS   | DM Sans | 18   | 100%
    | Body L     | DM Sans | 16   | 125%
    | Body M     | DM Sans | 15   | 140%
    | Body S     | DM Sans | 14   | 124%
    | DM Sans |
    Headline Large - Karelia
  */

  --font-primary: "DM Sans", sans-serif;
  --font-secondary: "Karelia Web Black", "DM Sans", sans-serif;
  --size-headline-l: 4rem; /* 64px */
  --size-headline-m: 3.75rem; /* 60px */
  --size-headline-s: 3.25rem; /* 52px */
  --size-title-xl: 2.25rem; /* 36px */
  --size-title-l: 1.875rem; /* 30px */
  --size-title-m: 1.375rem; /* 22px */
  --size-title-s: 1.1875rem; /* 19px */
  --size-title-xs: 1.125rem; /* 18px */
  --size-body-l: 1rem; /* 16px */
  --size-body-m: 0.9375rem; /* 15px */
  --size-body-s: 0.875rem; /* 14px */
}

/* FIXME: Remove */
:root {
  --base-size-4: 0.25rem;
  --base-size-8: 0.5rem;
  --base-size-16: 1rem;
  --base-size-24: 1.5rem;
  --base-size-40: 2.5rem;
  --base-text-weight-normal: 400;
  --base-text-weight-medium: 500;
  --base-text-weight-semibold: 600;
  --fontStack-monospace: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, "Noto Sans Mono",
    monospace;
}

:root,
[data-theme="light"] {
  /* light */
  color-scheme: light;
  --bgColor-attention-muted: #fff8c5;
  --bgColor-default: var(--white);
  --bgColor-intense: var(--clay);
  --bgColor-muted: var(--dark-sand);
  --bgColor-light: var(--sand);
  --bgColor-dark: #160408;
  --bgColor-neutral-muted: var(--sand-plus);
  --borderColor-accent-emphasis: #0969da;
  --borderColor-attention-emphasis: #9a6700;
  --borderColor-danger-emphasis: #cf222e;
  --borderColor-default: #3c071266;
  --borderColor-done-emphasis: #8250df;
  --borderColor-muted: #3c071233;
  --borderColor-neutral-muted: #d1d9e0b3;
  --borderColor-success-emphasis: #1a7f37;
  --fgColor-accent: #0969da;
  --fgColor-attention: #9a6700;
  --fgColor-danger: #d1242f;
  --fgColor-default: var(--burgundy);
  --fgColor-done: #8250df;
  --fgColor-intense: var(--sand);
  --fgColor-muted: #59636e;
  --fgColor-success: #1a7f37;
  --focus-outlineColor: #0969da;
}

[data-theme="dark"] {
  /* dark */
  color-scheme: dark;
  --bgColor-attention-muted: #bb800926;
  --bgColor-default: #0d1117;
  --bgColor-intense: #000;
  --bgColor-muted: #151b23;
  --bgColor-light: #1f2937;
  --bgColor-dark: #000;
  --bgColor-neutral-muted: #656c7633;
  --borderColor-accent-emphasis: #1f6feb;
  --borderColor-attention-emphasis: #9e6a03;
  --borderColor-danger-emphasis: #da3633;
  --borderColor-default: #3d444d;
  --borderColor-done-emphasis: #8957e5;
  --borderColor-muted: #3d444db3;
  --borderColor-neutral-muted: #3d444db3;
  --borderColor-success-emphasis: #238636;
  --fgColor-accent: #4493f8;
  --fgColor-attention: #d29922;
  --fgColor-danger: #f85149;
  --fgColor-default: #f0f6fc;
  --fgColor-done: #ab7df8;
  --fgColor-intense: #c9d1d9;
  --fgColor-muted: #9198a1;
  --fgColor-success: #3fb950;
  --focus-outlineColor: #1f6feb;
}

body {
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  margin: 0;
  color: var(--fgColor-default);
  background-color: var(--bgColor-default);
  font-family: var(--font-primary);
  font-size: 16px;
  line-height: 1.5;
  word-wrap: break-word;
}

/* =============== [ START ] GitHub Markdown Styles [ START ] =============== */
.octicon {
  display: inline-block;
  fill: currentColor;
  vertical-align: text-bottom;
}

h1:hover .anchor .octicon-link:before,
h2:hover .anchor .octicon-link:before,
h3:hover .anchor .octicon-link:before,
h4:hover .anchor .octicon-link:before,
h5:hover .anchor .octicon-link:before,
h6:hover .anchor .octicon-link:before {
  width: 16px;
  height: 16px;
  content: " ";
  display: inline-block;
  background-color: currentColor;
  -webkit-mask-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>");
  mask-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>");
}

details,
figcaption,
figure {
  display: block;
}

summary {
  display: list-item;
}

[hidden] {
  display: none !important;
}

a {
  background-color: transparent;
  color: var(--fgColor-accent);
  text-decoration: none;
}

abbr[title] {
  border-bottom: none;
  -webkit-text-decoration: underline dotted;
  text-decoration: underline dotted;
}

b,
strong {
  font-weight: var(--base-text-weight-semibold, 600);
}

dfn {
  font-style: italic;
}

mark {
  background-color: var(--bgColor-attention-muted);
  color: var(--fgColor-default);
}

small {
  font-size: 90%;
}

sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}

sub {
  bottom: -0.25em;
}

sup {
  top: -0.5em;
}

img {
  border-style: none;
  max-width: 100%;
  box-sizing: content-box;
  border-radius: var(--radius-small);
}

code,
kbd,
pre,
samp {
  font-family: monospace;
  font-size: 1em;
}

figure {
  margin: 1em var(--base-size-40);
}

hr {
  box-sizing: content-box;
  overflow: hidden;
  background: transparent;
  border-bottom: 1px solid var(--borderColor-muted);
  height: 0.25em;
  padding: 0;
  margin: var(--base-size-24) 0;
  background-color: var(--borderColor-default);
  border: 0;
}

input {
  font: inherit;
  margin: 0;
  overflow: visible;
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
}

[type="button"],
[type="reset"],
[type="submit"] {
  -webkit-appearance: button;
  appearance: button;
}

[type="checkbox"],
[type="radio"] {
  box-sizing: border-box;
  padding: 0;
}

[type="number"]::-webkit-inner-spin-button,
[type="number"]::-webkit-outer-spin-button {
  height: auto;
}

[type="search"]::-webkit-search-cancel-button,
[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
  appearance: none;
}

::-webkit-input-placeholder {
  color: inherit;
  opacity: 0.54;
}

::-webkit-file-upload-button {
  -webkit-appearance: button;
  appearance: button;
  font: inherit;
}

a:hover {
  text-decoration: underline;
}

::placeholder {
  color: var(--fgColor-muted);
  opacity: 1;
}

hr::before {
  display: table;
  content: "";
}

hr::after {
  display: table;
  clear: both;
  content: "";
}

table {
  border-collapse: collapse;
  border-spacing: 0;
  font-variant: tabular-nums;
  max-width: 100%;
  overflow: auto;
  width: fit-content;
}

td,
th {
  padding: 0;
}

details summary {
  cursor: pointer;
}

a:focus,
[role="button"]:focus,
input[type="radio"]:focus,
input[type="checkbox"]:focus {
  outline: 2px solid var(--focus-outlineColor);
  outline-offset: -2px;
  box-shadow: none;
}

a:focus:not(:focus-visible),
[role="button"]:focus:not(:focus-visible),
input[type="radio"]:focus:not(:focus-visible),
input[type="checkbox"]:focus:not(:focus-visible) {
  outline: solid 1px transparent;
}

a:focus-visible,
[role="button"]:focus-visible,
input[type="radio"]:focus-visible,
input[type="checkbox"]:focus-visible {
  outline: 2px solid var(--focus-outlineColor);
  outline-offset: -2px;
  box-shadow: none;
}

a:not([class]):focus,
a:not([class]):focus-visible,
input[type="radio"]:focus,
input[type="radio"]:focus-visible,
input[type="checkbox"]:focus,
input[type="checkbox"]:focus-visible {
  outline-offset: 0;
}

kbd {
  display: inline-block;
  padding: var(--base-size-4);
  font: 11px var(--fontStack-monospace);
  line-height: 10px;
  color: var(--fgColor-default);
  vertical-align: middle;
  background-color: var(--bgColor-muted);
  border: solid 1px var(--borderColor-neutral-muted);
  border-bottom-color: var(--borderColor-neutral-muted);
  border-radius: 6px;
  box-shadow: inset 0 -1px 0 var(--borderColor-neutral-muted);
}

h1,
h2,
h3,
h4,
h5,
h6 {
  margin-top: var(--base-size-24);
  margin-bottom: var(--base-size-16);
  font-weight: var(--base-text-weight-semibold, 600);
  line-height: 1.25;
}

h2 {
  font-weight: var(--base-text-weight-semibold, 600);
  padding-bottom: 0.3em;
  font-size: 1.5em;
  border-bottom: 1px solid var(--borderColor-muted);
}

h3 {
  font-weight: var(--base-text-weight-semibold, 600);
  font-size: var(--size-title-l);
}

h4 {
  font-weight: var(--base-text-weight-semibold, 600);
  font-size: var(--size-title-m);
}

h5 {
  font-weight: var(--base-text-weight-semibold, 600);
  font-size: var(--size-title-s);
}

h6 {
  font-weight: var(--base-text-weight-semibold, 600);
  font-size: var(--size-title-xs);
  font-style: italic;
}

p {
  margin-top: 0;
  margin-bottom: 10px;
}

blockquote {
  margin: 0;
  padding: 0 1em;
  color: var(--fgColor-muted);
  border-left: 0.25em solid var(--borderColor-default);
}

ul,
ol {
  margin-top: 0;
  margin-bottom: 0;
  padding-left: 2em;
}

ol ol,
ul ol {
  list-style-type: lower-roman;
}

ul ul ol,
ul ol ol,
ol ul ol,
ol ol ol {
  list-style-type: lower-alpha;
}

dd {
  margin-left: 0;
}

tt,
code,
samp {
  font-family: var(--fontStack-monospace);
  font-size: 12px;
}

pre {
  margin-top: 0;
  margin-bottom: 0;
  font-family: var(--fontStack-monospace);
  font-size: 12px;
  word-wrap: normal;
}

.octicon {
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  margin: 0;
  appearance: none;
}

.mr-2 {
  margin-right: var(--base-size-8, 8px) !important;
}

.markdown-body::before {
  display: table;
  content: "";
}

.markdown-body::after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body > *:first-child {
  margin-top: 0 !important;
}

.markdown-body > *:last-child {
  margin-bottom: 0 !important;
}

a:not([href]) {
  color: inherit;
  text-decoration: none;
}

.absent {
  color: var(--fgColor-danger);
}

.anchor {
  float: left;
  padding-right: var(--base-size-4);
  margin-left: -20px;
  line-height: 1;
}

.anchor:focus {
  outline: none;
}

p,
blockquote,
ul,
ol,
dl,
table,
pre,
details {
  margin-top: 0;
  margin-bottom: var(--base-size-16);
}

blockquote > :first-child {
  margin-top: 0;
}

blockquote > :last-child {
  margin-bottom: 0;
}

h1 .octicon-link,
h2 .octicon-link,
h3 .octicon-link,
h4 .octicon-link,
h5 .octicon-link,
h6 .octicon-link {
  color: var(--fgColor-default);
  vertical-align: middle;
  visibility: hidden;
}

h1:hover .anchor,
h2:hover .anchor,
h3:hover .anchor,
h4:hover .anchor,
h5:hover .anchor,
h6:hover .anchor {
  text-decoration: none;
}

h1:hover .anchor .octicon-link,
h2:hover .anchor .octicon-link,
h3:hover .anchor .octicon-link,
h4:hover .anchor .octicon-link,
h5:hover .anchor .octicon-link,
h6:hover .anchor .octicon-link {
  visibility: visible;
}

h1 tt,
h1 code,
h2 tt,
h2 code,
h3 tt,
h3 code,
h4 tt,
h4 code,
h5 tt,
h5 code,
h6 tt,
h6 code {
  padding: 0 0.2em;
  font-size: inherit;
}

summary h1,
summary h2,
summary h3,
summary h4,
summary h5,
summary h6 {
  display: inline-block;
}

summary h1 .anchor,
summary h2 .anchor,
summary h3 .anchor,
summary h4 .anchor,
summary h5 .anchor,
summary h6 .anchor {
  margin-left: -40px;
}

summary h1,
summary h2 {
  padding-bottom: 0;
  border-bottom: 0;
}

ul.no-list,
ol.no-list {
  padding: 0;
  list-style-type: none;
}

ol[type="a s"] {
  list-style-type: lower-alpha;
}

ol[type="A s"] {
  list-style-type: upper-alpha;
}

ol[type="i s"] {
  list-style-type: lower-roman;
}

ol[type="I s"] {
  list-style-type: upper-roman;
}

ol[type="1"] {
  list-style-type: decimal;
}

div > ol:not([type]) {
  list-style-type: decimal;
}

ul ul,
ul ol,
ol ol,
ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

li > p {
  margin-top: var(--base-size-16);
}

li + li {
  margin-top: 0.25em;
}

dl {
  padding: 0;
}

dl dt {
  padding: 0;
  margin-top: var(--base-size-16);
  font-size: 1em;
  font-style: italic;
  font-weight: var(--base-text-weight-semibold, 600);
}

dl dd {
  padding: 0 var(--base-size-16);
  margin-bottom: var(--base-size-16);
}

table th {
  font-weight: var(--base-text-weight-semibold, 600);
}

table th,
table td {
  padding: 6px 13px;
  border: 1px solid var(--borderColor-default);
}

table td {
  vertical-align: top;
}

table td > :last-child {
  margin-bottom: 0;
}

table tr {
  background-color: var(--bgColor-default);
  border-top: 1px solid var(--borderColor-muted);
}

table tr:nth-child(2n) {
  background-color: var(--bgColor-muted);
}

table img {
  background-color: transparent;
}

img[align="right"] {
  padding-left: 20px;
}

img[align="left"] {
  padding-right: 20px;
}

.emoji {
  max-width: none;
  vertical-align: text-top;
  background-color: transparent;
}

span.frame {
  display: block;
  overflow: hidden;
}

span.frame > span {
  display: block;
  float: left;
  width: auto;
  padding: 7px;
  margin: 13px 0 0;
  overflow: hidden;
  border: 1px solid var(--borderColor-default);
}

span.frame span img {
  display: block;
  float: left;
}

span.frame span span {
  display: block;
  padding: 5px 0 0;
  clear: both;
  color: var(--fgColor-default);
}

span.align-center {
  display: block;
  overflow: hidden;
  clear: both;
}

span.align-center > span {
  display: block;
  margin: 13px auto 0;
  overflow: hidden;
  text-align: center;
}

span.align-center span img {
  margin: 0 auto;
  text-align: center;
}

span.align-right {
  display: block;
  overflow: hidden;
  clear: both;
}

span.align-right > span {
  display: block;
  margin: 13px 0 0;
  overflow: hidden;
  text-align: right;
}

span.align-right span img {
  margin: 0;
  text-align: right;
}

span.float-left {
  display: block;
  float: left;
  margin-right: 13px;
  overflow: hidden;
}

span.float-left span {
  margin: 13px 0 0;
}

span.float-right {
  display: block;
  float: right;
  margin-left: 13px;
  overflow: hidden;
}

span.float-right > span {
  display: block;
  margin: 13px auto 0;
  overflow: hidden;
  text-align: right;
}

code,
tt {
  padding: 0.2em 0.4em;
  margin: 0;
  font-size: 85%;
  white-space: break-spaces;
  background-color: var(--bgColor-neutral-muted);
  border-radius: 6px;
}

code br,
tt br {
  display: none;
}

del code {
  text-decoration: inherit;
}

samp {
  font-size: 85%;
}

pre code {
  font-size: 100%;
}

pre > code {
  padding: 0;
  margin: 0;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

pre,
code {
  border-radius: var(--radius-medium);
}

pre code {
  counter-reset: step;
  counter-increment: step 0;
}

pre code .line::before {
  content: counter(step);
  counter-increment: step;
  width: 1rem;
  margin-right: 1.5rem;
  display: inline-block;
  text-align: right;
  color: #fff6;
}

pre code,
pre tt {
  display: inline;
  max-width: auto;
  padding: 0;
  margin: 0;
  overflow: visible;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
  text-wrap-mode: wrap;
}

.csv-data td,
.csv-data th {
  padding: 5px;
  overflow: hidden;
  font-size: 12px;
  line-height: 1;
  text-align: left;
  white-space: nowrap;
}

.csv-data .blob-num {
  padding: 10px var(--base-size-8) 9px;
  text-align: right;
  background: var(--bgColor-default);
  border: 0;
}

.csv-data tr {
  border-top: 0;
}

.csv-data th {
  font-weight: var(--base-text-weight-semibold, 600);
  background: var(--bgColor-muted);
  border-top: 0;
}

[data-footnote-ref]::before {
  content: "[";
}

[data-footnote-ref]::after {
  content: "]";
}

.footnotes {
  font-size: 12px;
  color: var(--fgColor-muted);
  border-top: 1px solid var(--borderColor-default);
}

.footnotes ol {
  padding-left: var(--base-size-16);
}

.footnotes ol ul {
  display: inline-block;
  padding-left: var(--base-size-16);
  margin-top: var(--base-size-16);
}

.footnotes li {
  position: relative;
}

.footnotes li:target::before {
  position: absolute;
  top: calc(var(--base-size-8) * -1);
  right: calc(var(--base-size-8) * -1);
  bottom: calc(var(--base-size-8) * -1);
  left: calc(var(--base-size-24) * -1);
  pointer-events: none;
  content: "";
  border: 2px solid var(--borderColor-accent-emphasis);
  border-radius: 6px;
}

.footnotes li:target {
  color: var(--fgColor-default);
}

.footnotes .data-footnote-backref g-emoji {
  font-family: monospace;
}

body:has(:modal) {
  padding-right: var(--dialog-scrollgutter) !important;
}

[role="button"]:focus:not(:focus-visible),
[role="tabpanel"][tabindex="0"]:focus:not(:focus-visible),
button:focus:not(:focus-visible),
summary:focus:not(:focus-visible),
a:focus:not(:focus-visible) {
  outline: none;
  box-shadow: none;
}

[tabindex="0"]:focus:not(:focus-visible),
details-dialog:focus:not(:focus-visible) {
  outline: none;
}

g-emoji {
  display: inline-block;
  min-width: 1ch;
  font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  font-size: 1em;
  font-style: normal !important;
  font-weight: var(--base-text-weight-normal, 400);
  line-height: 1;
  vertical-align: -0.075em;
}

g-emoji img {
  width: 1em;
  height: 1em;
}

.task-list-item {
  list-style-type: none;
}

.task-list-item label {
  font-weight: var(--base-text-weight-normal, 400);
}

.task-list-item.enabled label {
  cursor: pointer;
}

.task-list-item + .task-list-item {
  margin-top: var(--base-size-4);
}

.task-list-item .handle {
  display: none;
}

.task-list-item-checkbox {
  margin: 0 0.2em 0.25em -1.4em;
  vertical-align: middle;
}

.contains-task-list:hover .task-list-item-convert-container,
.contains-task-list:focus-within .task-list-item-convert-container {
  display: block;
  width: auto;
  height: 24px;
  overflow: visible;
  clip: auto;
}

.markdown-alert {
  padding: var(--base-size-8) var(--base-size-16);
  margin-bottom: var(--base-size-16);
  color: inherit;
  border-left: 0.25em solid var(--borderColor-default);
}

.markdown-alert > :first-child {
  margin-top: 0;
}

.markdown-alert > :last-child {
  margin-bottom: 0;
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: var(--base-text-weight-medium, 500);
  align-items: center;
  line-height: 1;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--borderColor-accent-emphasis);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--fgColor-accent);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--borderColor-done-emphasis);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--fgColor-done);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--borderColor-attention-emphasis);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--fgColor-attention);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--borderColor-success-emphasis);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--fgColor-success);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--borderColor-danger-emphasis);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--fgColor-danger);
}

.markdown-body > *:first-child > .heading-element:first-child {
  margin-top: 0 !important;
}
/* =============== [ END ] GitHub Markdown Styles [ END ] =============== */

/* =============== [ START ] Pygments Default [ START ] =============== */
.highlight .hll {
  background-color: #ffffcc;
}
.highlight {
  background: #f8f8f8;
}
.highlight .c {
  color: #408080;
  font-style: italic;
} /* Comment */
.highlight .err {
  border: 1px solid #ff0000;
} /* Error */
.highlight .k {
  color: #008000;
  font-weight: bold;
} /* Keyword */
.highlight .o {
  color: #666666;
} /* Operator */
.highlight .ch {
  color: #408080;
  font-style: italic;
} /* Comment.Hashbang */
.highlight .cm {
  color: #408080;
  font-style: italic;
} /* Comment.Multiline */
.highlight .cp {
  color: #bc7a00;
} /* Comment.Preproc */
.highlight .cpf {
  color: #408080;
  font-style: italic;
} /* Comment.PreprocFile */
.highlight .c1 {
  color: #408080;
  font-style: italic;
} /* Comment.Single */
.highlight .cs {
  color: #408080;
  font-style: italic;
} /* Comment.Special */
.highlight .gd {
  color: #a00000;
} /* Generic.Deleted */
.highlight .ge {
  font-style: italic;
} /* Generic.Emph */
.highlight .gr {
  color: #ff0000;
} /* Generic.Error */
.highlight .gh {
  color: #000080;
  font-weight: bold;
} /* Generic.Heading */
.highlight .gi {
  color: #00a000;
} /* Generic.Inserted */
.highlight .go {
  color: #888888;
} /* Generic.Output */
.highlight .gp {
  color: #000080;
  font-weight: bold;
} /* Generic.Prompt */
.highlight .gs {
  font-weight: bold;
} /* Generic.Strong */
.highlight .gu {
  color: #800080;
  font-weight: bold;
} /* Generic.Subheading */
.highlight .gt {
  color: #0044dd;
} /* Generic.Traceback */
.highlight .kc {
  color: #008000;
  font-weight: bold;
} /* Keyword.Constant */
.highlight .kd {
  color: #008000;
  font-weight: bold;
} /* Keyword.Declaration */
.highlight .kn {
  color: #008000;
  font-weight: bold;
} /* Keyword.Namespace */
.highlight .kp {
  color: #008000;
} /* Keyword.Pseudo */
.highlight .kr {
  color: #008000;
  font-weight: bold;
} /* Keyword.Reserved */
.highlight .kt {
  color: #b00040;
} /* Keyword.Type */
.highlight .m {
  color: #666666;
} /* Literal.Number */
.highlight .s {
  color: #ba2121;
} /* Literal.String */
.highlight .na {
  color: #7d9029;
} /* Name.Attribute */
.highlight .nb {
  color: #008000;
} /* Name.Builtin */
.highlight .nc {
  color: #0000ff;
  font-weight: bold;
} /* Name.Class */
.highlight .no {
  color: #880000;
} /* Name.Constant */
.highlight .nd {
  color: #aa22ff;
} /* Name.Decorator */
.highlight .ni {
  color: #999999;
  font-weight: bold;
} /* Name.Entity */
.highlight .ne {
  color: #d2413a;
  font-weight: bold;
} /* Name.Exception */
.highlight .nf {
  color: #0000ff;
} /* Name.Function */
.highlight .nl {
  color: #a0a000;
} /* Name.Label */
.highlight .nn {
  color: #0000ff;
  font-weight: bold;
} /* Name.Namespace */
.highlight .nt {
  color: #008000;
  font-weight: bold;
} /* Name.Tag */
.highlight .nv {
  color: #19177c;
} /* Name.Variable */
.highlight .ow {
  color: #aa22ff;
  font-weight: bold;
} /* Operator.Word */
.highlight .w {
  color: #bbbbbb;
} /* Text.Whitespace */
.highlight .mb {
  color: #666666;
} /* Literal.Number.Bin */
.highlight .mf {
  color: #666666;
} /* Literal.Number.Float */
.highlight .mh {
  color: #666666;
} /* Literal.Number.Hex */
.highlight .mi {
  color: #666666;
} /* Literal.Number.Integer */
.highlight .mo {
  color: #666666;
} /* Literal.Number.Oct */
.highlight .sa {
  color: #ba2121;
} /* Literal.String.Affix */
.highlight .sb {
  color: #ba2121;
} /* Literal.String.Backtick */
.highlight .sc {
  color: #ba2121;
} /* Literal.String.Char */
.highlight .dl {
  color: #ba2121;
} /* Literal.String.Delimiter */
.highlight .sd {
  color: #ba2121;
  font-style: italic;
} /* Literal.String.Doc */
.highlight .s2 {
  color: #ba2121;
} /* Literal.String.Double */
.highlight .se {
  color: #bb6622;
  font-weight: bold;
} /* Literal.String.Escape */
.highlight .sh {
  color: #ba2121;
} /* Literal.String.Heredoc */
.highlight .si {
  color: #bb6688;
  font-weight: bold;
} /* Literal.String.Interpol */
.highlight .sx {
  color: #008000;
} /* Literal.String.Other */
.highlight .sr {
  color: #bb6688;
} /* Literal.String.Regex */
.highlight .s1 {
  color: #ba2121;
} /* Literal.String.Single */
.highlight .ss {
  color: #19177c;
} /* Literal.String.Symbol */
.highlight .bp {
  color: #008000;
} /* Name.Builtin.Pseudo */
.highlight .fm {
  color: #0000ff;
} /* Name.Function.Magic */
.highlight .vc {
  color: #19177c;
} /* Name.Variable.Class */
.highlight .vg {
  color: #19177c;
} /* Name.Variable.Global */
.highlight .vi {
  color: #19177c;
} /* Name.Variable.Instance */
.highlight .vm {
  color: #19177c;
} /* Name.Variable.Magic */
.highlight .il {
  color: #666666;
} /* Literal.Number.Integer.Long */
/* =============== [ END ] Pygments Default [ END ] =============== */

main,
footer {
  box-sizing: border-box;
}

/* ---------- [ Icons ] ---------- */
.ph {
  display: inline-block;
}
.ph.size-1x {
  font-size: 1em;
}
.ph.size-2x {
  font-size: 2em;
}
.ph.size-3x {
  font-size: 3em;
}
.ph.size-4x {
  font-size: 4em;
}
.ph.size-5x {
  font-size: 5em;
}
.ph.size-lg {
  font-size: 6em;
}
.ph.size-fw {
  font-size: 1em;
} /* FIXME - Fixed width */

.ph.flip-horizontal {
  transform: scaleX(-1);
}
.ph.flip-vertical {
  transform: scaleY(-1);
}

.ph.rotate-90 {
  transform: rotate(90deg);
}
.ph.rotate-180 {
  transform: rotate(180deg);
}
.ph.rotate-270 {
  transform: rotate(270deg);
}

.accent {
  color: var(--fgColor-accent);
}
.success {
  color: var(--fgColor-success);
}
.attention {
  color: var(--fgColor-attention);
}
.danger {
  color: var(--fgColor-danger);
}
.done {
  color: var(--fgColor-done);
}

/* ---------- [ Layout ] ---------- */
.columns {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.column {
  flex: 1;
}
.column.is-one-third {
  flex: 0 0 33.3333%;
}
.column.is-half {
  flex: 0 0 50%;
}
.column.is-two-thirds {
  flex: 0 0 66.6667%;
}
.columns > *:not(.column) {
  flex: 0 0 100%;
}

/* FIXME - Printable syntax highlighting */

/* ---------- [ Agenda Slide ] ---------- */
.agenda {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-column-gap: 1rem;
  grid-row-gap: 1rem;

  header {
    grid-column: span 2;
  }

  p {
    counter-increment: section;
    background: var(--bgColor-light);
    font-size: var(--size-body-m);
    padding: 0.75rem;

    .title {
      text-align: left;
      display: block;
      font-weight: bold;
      font-size: var(--size-body-l);
    }

    &::before {
      content: counter(section);
      font-weight: bold;
      background: var(--bright-orange);
      color: var(--white);
      width: 1.5rem;
      height: 1.5rem;
      display: block;
      text-align: center;
      line-height: 1.5rem;
      font-size: var(--size-body-l);
      margin-top: -0.75rem;
      margin-left: -0.75rem;
    }
  }
}

/* ---------- [ Text Sizes & Styles ] ---------- */
/* FIXME Think through these sizes more */
.lead {
  font-size: var(--size-title-l);
}
.big {
  font-size: var(--size-title-m);
}
.small {
  font-size: var(--size-body-s);
}

.underline:before,
.line-through:before {
  content: "DO NOT USE ";
}

.underline,
.line-through {
  background: red;
  color: yellow;
}

/* FIXME Style mark better */
/* FIXME Style blockquotes better */

/* Alignment */
.text-justify {
  text-align: justify;
}

.text-left {
  text-align: left;
}

.text-right {
  text-align: right;
}

.text-center {
  text-align: center;
}

h1 {
  font-family: var(--font-secondary);
  font-size: var(--size-headline-l);
  line-height: 105%;
}

ul.checklist {
  list-style-type: none;
  padding-left: 0.6rem;

  li i.ph {
    font-weight: bold;
    top: 1px;
    position: relative;
    padding-right: 0.4rem;
  }
}

/* ---------- [ Container ] ---------- */

.container {
  width: 100%;
  margin: 0 auto;
  padding: 0 1rem;
  box-sizing: border-box;
}

@media screen {
  @media (min-width: 1024px) {
    .container {
      max-width: 100%;
    }
  }
  @media (min-width: 1200px) {
    .container {
      max-width: 1100px;
    }
  }
  @media (min-width: 1280px) {
    .container {
      max-width: 1200px;
    }
  }
  @media (min-width: 1366px) {
    .container {
      max-width: 1300px;
    }
  }
  @media (min-width: 1440px) {
    .container {
      max-width: 1350px;
    }
  }
  @media (min-width: 1536px) {
    .container {
      max-width: 1450px;
    }
  }
}

/* ---------- [ Navbar ] ---------- */
#nav {
  background-color: var(--bgColor-muted);
  border-bottom: 1px solid var(--borderColor-muted);
  height: 4rem;
  max-width: 100vw;
  position: fixed;
  top: 0;
  width: 100vw;
  z-index: 11;
}

#nav > .container {
  align-items: center;
  display: flex;
  height: 100%;
  justify-content: space-between;

  display: flex;
  gap: var(--padding-sm);
  align-items: center;
}

#nav .title {
  font-family: var(--font-secondary);
  font-size: var(--size-title-m);
  font-weight: bold;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#nav .fill {
  flex-grow: 1;
}

#nav a {
  display: inline-block;
  align-items: center;
}

#nav button {
  cursor: pointer;
  padding: 0 1rem 0 0;
  margin: 0;
  background: none;
  border: none;
  vertical-align: middle;
}

/* Adjust SVG colors on theme change */
#nav svg {
  color: var(--fgColor-default);
  height: 2rem;
}
[data-theme="dark"] #nav svg.dark {
  display: none;
}
[data-theme="light"] #nav svg.light {
  display: none;
}
#nav .logo svg {
  width: 9rem;
  height: auto;
  color: #390b14;
}
[data-theme="dark"] #nav .logo svg {
  color: #fff;
}

/* ---------- [ Content Layout ] ---------- */
@media screen {
  #layout {
    display: grid;
    grid-template:
      "sidebar header" auto
      "sidebar content" 1fr
      "footer footer" auto
      / 33% 1fr;
    margin-top: 4rem;
    gap: 2rem;
  }

  #layout .document-content {
    grid-area: content;
  }
  #layout .document-sidebar {
    grid-area: sidebar;
    max-width: 375px;
  }
  #layout .document-header {
    grid-area: header;
  }

  .document-sidebar .sidebar-content {
    border-right: 1px solid var(--borderColor-muted);
    position: sticky;
    top: 4rem;
    height: calc(100vh - 4rem);
    overflow-y: auto;
    padding: 1rem;
  }

  .document-sidebar.overlay .sidebar-content {
    background-color: var(--bgColor-muted);
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
    display: block; /* Visible when overlay class is added */
    height: 100vh;
    left: 0;
    max-width: 375px;
    min-height: 100vh;
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 1000;
  }

  .document-sidebar.overlay .overlay-background {
    background: var(--bgColor-default);
    height: 100vh;
    left: 0;
    opacity: 0.9;
    position: fixed;
    top: 0;
    width: 100vw;
    z-index: 50;
  }

  .document-content {
    margin-top: 4rem;
  }
}

/* ---------- [ Table of Contents ] ---------- */
.document-sidebar nav ul {
  list-style-type: none;
  display: block;
  padding: 0;

  ul {
    padding-left: 1rem;

    /* The colophon / copyright notice adds an extra list item that we don't want to display */
    &.sectlevel1 > li:last-child {
      display: none !important;
    }
  }

  li {
    &.open .sectlevel2,
    &.open .sectlevel3 {
      display: block;
    }

    &.closed .sectlevel2,
    &.closed .sectlevel3 {
      display: none;
    }

    a {
      display: block;
      color: var(--fgColor-default);
      padding: 0.25rem 0.65rem;

      &.active {
        box-shadow: inset max(3px, 0.1875rem, 0.12em) 0 0 var(--fgColor-accent);
        color: var(--fgColor-accent);
        font-weight: bold;
      }

      &.parent-active {
        box-shadow: inset max(3px, 0.1875rem, 0.12em) 0 0 var(--fgColor-muted);
        color: var(--fgColor-muted);
        font-weight: bold;
      }
    }
  }
}


/* ---------- [ Sidebar Toggle ] ---------- */
#toggle-sidebar {
  display: none;
}

@media (max-width: 1024px) {
  #layout {
    grid-template:
      "header" auto
      "content" 1fr
      "footer" auto;
  }

  .document-sidebar {
    display: none;
  }

  #toggle-sidebar {
    cursor: pointer;
    display: inline-block;
    padding: 0 1rem 0 0;
    margin: 0;
    background: none;
    border: none;
    vertical-align: middle;
  }
}

.document-sidebar.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 80%;
  height: 100vh;
  min-height: 100vh;
  background-color: var(--background-primary);
  z-index: 1000;
  box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
  display: block; /* Visible when overlay class is added */
}



/* ---------- [ Course Header ] ---------- */

.document-header {
  grid-area: header;
  background: var(--bgColor-intense);
  border-radius: var(--radius-medium);
  color: var(--fgColor-intense);
  margin-top: var(--padding-md);
  padding: var(--padding-lg) var(--padding-md) var(--padding-xxl);

  .subtitle {
    font-family: var(--font-secondary);
    font-size: var(--size-title-l);
    line-height: 105%;
    margin-bottom: 0;
  }

  h1 {
    margin-top: 0;
  }
}

/* ---------- [ Chapter Header ] ---------- */
.sect1 > header {
  background: var(--bgColor-light);
  color: var(--fgColor-default);
  font-size: var(--size-title-xl);
  padding: var(--padding-lg) var(--padding-md) var(--padding-md);
  border-radius: var(--radius-medium);
}

.sect1 > header .subtitle {
  font-family: var(--font-secondary);
  font-size: var(--size-title-m);
  font-weight: 900;
  margin-bottom: 0;
  line-height: 105%;
}

.sect1 > header h2 {
  border-bottom: 0;

  font-family: var(--font-secondary);
  font-size: var(--size-headline-s);
  line-height: 105%;
  font-weight: 300;
  padding: 0 0 0.5rem;
  margin: 0;
}

/**
 * Objectives:
 * Headers followed by objectives are styled differently to put the objectives in the same
 * background "box" as the header, even though they are separate elements.
 */
.sect1 > header:has(+ .objectives) {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
}

.objectives {
  background: var(--bgColor-light);
  border-bottom-left-radius: var(--radius-medium);
  border-bottom-right-radius: var(--radius-medium);
  font-size: var(--size-body-l);
  padding: var(--padding-md);
  /*
  border-top: 5px solid var(--borderColor-default);
  margin: 0.25in 0 0;
  padding: 0.25in 0 0;
  */
}

.objectives li {
  padding-left: var(--padding-xs);
}

.objectives li::marker {
  content: ""; /* Phosphor Icon Check Unicode */
  font-family: "Phosphor";
  font-weight: bold;
}

/* ---------- [ Section Header ] ---------- */
.sect2 {
  margin-top: var(--padding-lg);
}

.sect2 h3 {
  font-family: var(--font-secondary);
  font-size: var(--size-title-l);
  line-height: 105%;
}

/* ---------- [ Footnotes ] ---------- */
.document-content {
  margin-bottom: var(--padding-lg);
}

.footnotes {
  font-size: var(--size-body-m);
  color: var(--fgColor-muted);
  margin-top: var(--padding-lg);
  padding-top: var(--padding-md);
  border-top: 1px solid var(--borderColor-muted);
}

/* ---------- [ Footer ] ---------- */

.document-footer {
  background: var(--bgColor-muted);
  border-top: 1px solid var(--borderColor-muted);
  color: var(--fgColor-muted);
  padding-bottom: var(--padding-md);
  padding-top: var(--padding-sm);
}

.colophon {
  font-size: var(--size-body-s);
}

/* ---------- [ Misc Content ] ---------- */
/* Captions */
.exampleblock .title,
.listingblock .title,
table caption {
  font-style: italic;
  text-align: center;
}

.listingblock.wrap-text pre {
  white-space: pre-wrap;
}

.exampleblock .content {
  border-radius: var(--radius-small);
  background: var(--bgColor-light);
  padding: var(--padding-xs);
}

/* Quotes */
.quoteblock {
  margin-bottom: var(--padding-sm);
}

/* ---------- [ Instructor Notes ] ---------- */
.notes-title {
  font-weight: bold;
}

/* ---------- [ Print Layout ] ---------- */
@media only screen {
  .print-colophon {
    display: none;
  }
}

@media print {
  /* Page Layouts */
  @page {
    size: 8.5in 11in;
    margin: 1in;

    @top-left {
      color: var(--fgColor-default);
    }
    @top-right {
      color: var(--fgColor-default);
    }
    @bottom-left {
      color: var(--fgColor-default);
      content: counter(page);
    }
    @bottom-right {
      color: var(--fgColor-default);
      content: "© Ascendient, LLC";
    }
  }

  body {
    background: transparent !important;
    color: #141414;
  }

  #layout {
    display: block;
    margin-top: 0;
  }

  #nav,
  .document-footer {
    display: none;
  }

  .container {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 0;
  }

  .columns h3 {
    margin-bottom: 0 !important;
  }
  
  .column {
    margin: var(--base-size-16) 0.1in 0;

    &:first-child {
      margin-left: 0;
    }

    &:last-child {
      margin-right: 0;
    }
  }

  /* Cover Page */
  @page cover {
    @top-left {
      content: none;
    }
    @top-right {
      content: none;
    }
    @bottom-left {
      content: none;
    }
    @bottom-right {
      content: var(--ascendient-logo);
      width: 2in;
    }

    background: var(--bgColor-intense);
    margin: 2in 1in 3in;
  }

  #layout .document-header {
    border-radius: 0;
    color: var(--dark-sand) !important;
    height: 100%;
    width: 100%;
    page: cover;
    break-after: always;
    margin: 0;
    padding: 0;
  }

  /* Chapter headers */
  @page chapter {
    @top-left {
      content: none;
    }
    @top-right {
      content: none;
    }
    @bottom-left {
      content: none;
    }
    @bottom-right {
      content: none;
    }

    background: var(--sand);
    margin: 5in 1in 2in;
  }

  .sect1 > header {
    margin: 0;
    padding: 0;
    page-break-after: always;
    page-break-before: always;
    page: chapter;
    text-align: right;
  }

  .sect1 > header:has(+ .objectives) {
    page-break-after: avoid;
  }

  .sect1 > header h2 {
    align-self: end;
    border-bottom: 0;
    font-family: var(--font-secondary);
    font-size: var(--size-headline-s);
    line-height: 105%;
  }

  .sect1 > header .subtitle {
    text-transform: uppercase;
  }

  .objectives {
    page: chapter;
    page-break-after: always;
  }

  .objectives {
    border-top: 5px solid var(--borderColor-default);
    margin: 0.25in 0 0;
    padding: 0.25in 0 0;
  }

  /* Fixes a bug in WeasyPrint where list icons are not padded. */
  .objectives li::before {
    content: "";
    padding-left: var(--padding-xs);
  }

  .sect1 > header + .objectives + .sect2 {
    margin-top: 0;
  }

  /* Section headers */
  .document-content header h3 {
    font-size: var(--size-title-m) !important;
    color: var(--fgColor-default) !important;
  }

  /* Table of Contents */
  .document-sidebar {
    nav ul li a {
      padding: 0;
    }

    nav > ul > ul {
      margin-bottom: var(--padding-sm);
    }

    nav ul ul ul {
      padding-left: 2rem;
    }

    .sidebar-content {
      border-right: none;
      height: auto;
      max-height: none;
      max-width: none;
      overflow: visible;
      position: initial;
      width: 100%;
      
      h2 {
        color: var(--fgColor-default);
        font-size: var(--size-title-l);
        border-bottom: 0;
        margin-top: 0;
      }

      li a::after {
        content: leader(".") target-counter(attr(href), page);
      }

      /* Never show the 4th level sections */
      ul li .sectlevel4 { display: none; }

      /* Don't show the copyright list item (this has to be set again for some reason) */
      ul.sectlevel1 > li:last-child {
        display: none !important;
      }
    }
  }

  /* Avoid Page Breaks */
  .notes,
  .tableblock {
    page-break-inside: avoid;
  }

  /* Images */
  img {
    max-width: 100% !important;
    max-height: 50%;
    width: auto;
  }

  .column img {
    width: 100%;
  }

  /* This allows images to be displayed more similarly to the browser. When images are too large,
  the will be resized to fit */
  table img {
    width: 100%;
  }

  /* Break long code lines */
  pre {
    max-width: 100%;

    code {
      white-space: pre-wrap;
    }
  }

  /* Colophon */
  @page colophon {
    @top-left {
      content: none;
    }
    @top-right {
      content: none;
    }
    @bottom-left {
      content: none;
    }
    @bottom-right {
      content: none;
    }

    background: var(--sand);
  }

  .print-colophon {
    color: var(--fgColor-default);
    display: block;
    page: colophon;
    page-break-after: always;
  }
}

  </style>
  <title>Lab Guide: WA3581 Advanced Terraform and IaC Workflows</title>
</head>
<body>
  <nav id="nav">
    <div class="container">
      <a href="https://www.ascendientlearning.com/" class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 4176 1618"><path d="M1035 911v249h-75v-38c-24 29-61 45-107 45-77 0-139-51-139-119s61-110 153-110h88v-33c0-49-15-67-73-67s-75 18-78 69h-80c11-74 75-136 162-136s149 57 149 140Zm-80 128v-40H849c-34 0-50 14-50 39v20c0 31 20 45 71 45 60 0 85-19 85-64Zm120 5h83c3 45 22 58 83 58 55 0 80-14 80-43v-15c0-23-15-32-55-37l-63-5c-70-7-115-47-115-107 0-67 69-124 150-124s148 48 158 122h-83c-2-42-20-56-74-56-49 0-71 12-71 41v13c0 23 14 34 49 37l70 8c71 7 114 46 114 105 0 69-69 126-158 126s-159-50-168-123Zm357-75c0-112 77-198 180-198 88 0 160 64 175 154h-87c-4-61-28-83-89-83s-90 29-90 96v61c0 69 27 98 90 98s85-23 89-84h87c-15 90-87 154-175 154-102 0-180-85-180-198Zm479 23v18c0 64 29 90 96 90 58 0 84-18 88-61h88c-23 73-96 128-175 128-105 0-185-78-185-192s78-204 186-204c99 0 176 85 176 191v30h-274Zm0-70v9h185v-9c0-60-24-84-87-84-68 0-98 25-98 84Zm664 0v238h-82V917c0-51-25-74-83-74-61 0-88 24-88 78v239h-82V779h77v55c29-40 72-63 122-63 78 0 136 64 136 151Zm405-283v521h-77v-52c-27 35-74 59-118 59-95 0-172-88-172-197s78-199 175-199c43 0 82 19 110 52V639h82Zm-82 299c0-67-30-96-99-96s-97 29-97 96v61c0 69 30 98 97 98s99-29 99-98v-61Zm118-258c0-33 24-56 57-56s57 23 57 56-24 56-57 56-57-23-57-56Zm17 99h82v381h-82V779Zm216 213v18c0 64 29 90 96 90 59 0 84-18 88-61h88c-23 73-96 128-175 128-105 0-185-78-185-192s78-204 186-204c99 0 176 85 176 191v30h-274Zm0-70v9h185v-9c0-60-24-84-87-84-68 0-98 25-98 84Zm650 0v238h-82V917c0-51-25-74-83-74-61 0-87 24-87 78v239h-82V779h76v55c29-40 73-63 123-63 77 0 135 64 135 151Zm93 126V847h-80v-68h80V639h81v140h103v68h-103v205c0 25 13 37 38 37h58v75h-54c-75 0-123-45-123-116ZM466 163l147 103L409 4c-2-3-5-4-9-4-2 0-5 1-7 3l-34 29c-5 4-5 11-1 16l108 115Zm-230-14 204 117 100 32 39 13 39 13 17 5-34-24-81-56-80-56L280 80c-3-2-5-3-8-3-5 0-9 3-12 7l-29 45c-4 7-2 16 5 20ZM129 311l322 73 120 2 41 1h45l24 1h6l-5-2-17-5-22-7-7-3-26-8-14-5-79-25-93-31-268-87-5-1c-8 0-15 5-17 12l-17 64c-3 9 3 19 12 21ZM61 538h2l444-33 132-38 40-12 39-11 12-3 23-7 17-5h-36l-32-1-60-1-98-2-98-2-387-7c-12 0-21 9-21 21l2 80c1 12 10 21 21 21Zm5 288 546-213 134-87 35-22 49-32 19-12 32-21-32 9-20 6-19 5-47 13-43 13-18 5-94 27-94 26L18 685c-14 4-21 19-17 32l32 93a26 26 0 0 0 33 16Zm877-380-17 11-17 11-59 38-22 14-34 22-82 53-82 53-564 365a31 31 0 0 0-8 44l70 97a31 31 0 0 0 44 7l875-691-45-62-59 38Zm2037 822h33v269h-33v-269Zm90 181v8c0 39 17 54 57 54 31 0 46-10 49-34h38a97 97 0 0 1-87 64c-54 0-93-41-93-98s40-106 93-106c49 0 88 43 88 98v14h-145Zm0-32v4h108v-5c0-35-14-50-51-50-39 0-57 16-57 51Zm323-8v128h-31v-22a71 71 0 0 1-58 26c-40 0-71-27-71-61s30-55 73-55h54v-18c0-29-10-41-42-41s-45 11-46 41h-34c7-40 39-70 81-70 44 0 74 29 74 72Zm-33 68v-24h-64c-18 0-27 7-27 22v10c0 19 12 26 42 26 34 0 49-10 49-34Zm164-140v42h-31c-26 0-38 12-38 38v120h-33v-196h31v37c15-23 40-37 71-41Zm186 77v123h-33v-126c0-32-15-45-48-45-36 0-51 14-51 46v125h-33v-196h31v29c15-21 37-33 63-33 41 0 71 32 71 77Zm23-123c0-15 11-25 25-25s26 10 26 25-11 25-26 25-25-10-25-25Zm9 50h33v196h-33v-196Zm233 73v123h-33v-126c0-32-15-45-48-45-36 0-51 14-51 46v125h-33v-196h31v29c15-21 37-33 63-33 41 0 71 32 71 77Zm201-73v202c0 41-35 75-86 75s-87-35-88-74h34c0 34 14 45 54 45s53-13 53-50v-38a80 80 0 0 1-61 28c-49 0-86-41-86-96s37-96 87-96c24 0 49 13 62 32v-28h31Zm-33 103v-23c0-38-16-54-55-54s-56 16-56 54v23c0 40 17 57 56 57s55-17 55-57Z"/></svg>
      </a>
      <span class="title">WA3581 Advanced Terraform and IaC Workflows</span>
      <span class="fill"></span>
      <button id="toggle-theme" aria-label="Toggle Theme" onclick="toggleTheme()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="dark" viewBox="0 0 256 256"><path d="M234 142a8 8 0 0 0-8-2A88 88 0 0 1 116 30a8 8 0 0 0-10-10 105 105 0 0 0-53 37 104 104 0 0 0 83 167 103 103 0 0 0 63-21 105 105 0 0 0 37-53 8 8 0 0 0-2-8Zm-45 48A88 88 0 0 1 66 67a89 89 0 0 1 31-26 106 106 0 0 0-1 15 104 104 0 0 0 104 104 106 106 0 0 0 15-1 89 89 0 0 1-26 31Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="light" viewBox="0 0 256 256"><path d="M120 40V16a8 8 0 0 1 16 0v24a8 8 0 0 1-16 0Zm72 88a64 64 0 1 1-64-64 64 64 0 0 1 64 64Zm-16 0a48 48 0 1 0-48 48 48 48 0 0 0 48-48ZM58 70a8 8 0 0 0 12-12L54 42a8 8 0 0 0-12 12Zm0 116-16 16a8 8 0 0 0 12 12l16-16a8 8 0 0 0-12-12ZM192 72a8 8 0 0 0 6-2l16-16a8 8 0 0 0-12-12l-16 16a8 8 0 0 0 6 14Zm6 114a8 8 0 0 0-12 12l16 16a8 8 0 0 0 12-12ZM48 128a8 8 0 0 0-8-8H16a8 8 0 0 0 0 16h24a8 8 0 0 0 8-8Zm80 80a8 8 0 0 0-8 8v24a8 8 0 0 0 16 0v-24a8 8 0 0 0-8-8Zm112-88h-24a8 8 0 0 0 0 16h24a8 8 0 0 0 0-16Z"/></svg>
      </button>
      <button id="toggle-sidebar" aria-label="Toggle Sidebar" onclick="toggleSidebar()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256"><path d="M224 128a8 8 0 0 1-8 8H40a8 8 0 0 1 0-16h176a8 8 0 0 1 8 8ZM40 72h176a8 8 0 0 0 0-16H40a8 8 0 0 0 0 16Zm176 112H40a8 8 0 0 0 0 16h176a8 8 0 0 0 0-16Z"/></svg>
      </button>
    </div>
  </nav>
  <div id="layout" class="container">
    <header class="document-header">
      <p class="subtitle">WA3581 Lab Guide</p>
      <h1>Advanced Terraform and IaC Workflows</h1>
    </header>
    <div class="print-colophon">
      <p>© 2025 Ascendient, LLC</p>
<p>Revision 1.0.1 published on 2025-04-16.</p>
<p>No part of this book may be reproduced or used in any form or by any electronic, mechanical, or other means, currently available or developed in the future, including photocopying, recording, digital scanning, or sharing, or in any information storage or retrieval system, without permission in writing from the publisher.</p>
<p><strong>Trademark Notice:</strong> Product or corporate names may be trademarks or registered trademarks, and are used only for identification and explanation without intent to infringe.</p>
<p>To obtain authorization for any such activities (e.g., reprint rights, translation rights), to customize this book, or for other sales inquiries, please contact:</p>
<p>Ascendient, LLC<br>
1 California Street Suite 2900<br>
San Francisco, CA 94111<br>
<a href="https://www.ascendientlearning.com/" class="bare">https://www.ascendientlearning.com/</a></p>
<p>USA: 1-877-517-6540, email: <a href="mailto:getinfousa@ascendientlearning.com">getinfousa@ascendientlearning.com</a><br>
Canada: 1-877-812-8887 toll free, email: <a href="mailto:getinfo@ascendientlearning.com">getinfo@ascendientlearning.com</a></p>
    </div>
    <aside class="document-sidebar">
      <div class="overlay-background"></div>
      <div id="toc" class="sidebar-content">
        <header>
          <h2>Table of Contents</h2>
        </header>
        <nav>
          <ul class="sectlevel1">
<li><a href="#_lab_setting_up_cloud_workflows">1. Lab: Setting Up Cloud Workflows</a>
<ul class="sectlevel2">
<li><a href="#_configure_your_environment">1.1. Configure Your Environment</a>
<ul class="sectlevel3">
<li><a href="#_install_command_line_tools">1.1.1. Install Command-Line Tools</a></li>
<li><a href="#_set_up_accounts_and_log_in">1.1.2. Set Up Accounts and Log In</a></li>
<li><a href="#_create_and_configure_aws_credentials">1.1.3. Create and Configure AWS Credentials</a></li>
<li><a href="#_configure_git">1.1.4. Configure Git</a></li>
<li><a href="#_prepare_your_course_repository">1.1.5. Prepare Your Course Repository</a></li>
<li><a href="#_set_up_vscode">1.1.6. Set up VSCode</a></li>
</ul>
</li>
<li><a href="#_configure_hcp_organization_workspace_and_vcs_connection">1.2. Configure HCP Organization, Workspace and VCS Connection</a>
<ul class="sectlevel3">
<li><a href="#_create_a_new_organization">1.2.1. Create a New Organization</a></li>
<li><a href="#_create_aws_credentials_variable_set">1.2.2. Create AWS Credentials Variable Set</a></li>
<li><a href="#_create_a_new_workspace">1.2.3. Create a New Workspace</a></li>
<li><a href="#_connect_to_github_and_configure_workspace">1.2.4. Connect to GitHub and Configure Workspace</a></li>
<li><a href="#_trigger_manual_run">1.2.5. Trigger Manual Run</a></li>
<li><a href="#_understanding_the_lab_repository_structure">1.2.6. Understanding the Lab Repository Structure</a></li>
<li><a href="#_verification">1.2.7. Verification</a></li>
</ul>
</li>
<li><a href="#_trigger_run_via_vcs_workflow">1.3. Trigger Run via VCS Workflow</a>
<ul class="sectlevel3">
<li><a href="#_define_initial_infrastructure">1.3.1. Define Initial Infrastructure</a></li>
<li><a href="#_commit_and_push_code">1.3.2. Commit and Push Code</a></li>
<li><a href="#_observe_hcp_run">1.3.3. Observe HCP Run</a></li>
<li><a href="#_confirm_and_apply">1.3.4. Confirm and Apply</a></li>
<li><a href="#_verification_2">1.3.5. Verification</a></li>
</ul>
</li>
<li><a href="#_trigger_run_via_cli_workflow">1.4. Trigger Run via CLI Workflow</a>
<ul class="sectlevel3">
<li><a href="#_login_to_terraform_cloud">1.4.1. Login to Terraform Cloud</a></li>
<li><a href="#_initialize_for_remote_backend">1.4.2. Initialize for Remote Backend</a></li>
<li><a href="#_run_plan_locally_executes_remotely">1.4.3. Run Plan Locally (Executes Remotely)</a></li>
<li><a href="#_apply_not_allowed_throught_cli">1.4.4. Apply Not Allowed throught CLI</a></li>
</ul>
</li>
<li><a href="#_cleanup">1.5. Cleanup</a></li>
<li><a href="#_troubleshooting">1.6. Troubleshooting</a></li>
<li><a href="#_review">1.7. Review</a></li>
</ul>
</li>
<li><a href="#_lab_crafting_reusable_components">2. Lab: Crafting Reusable Components</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites_and_setup">2.1. Prerequisites and Setup</a></li>
<li><a href="#_lab_scenario_building_a_secure_message_queue_component">2.2. Lab Scenario: Building a Secure Message Queue Component</a></li>
<li><a href="#_create_module_structure">2.3. Create Module Structure</a>
<ul class="sectlevel3">
<li><a href="#_create_directories_and_files">2.3.1. Create Directories and Files</a></li>
</ul>
</li>
<li><a href="#_define_module_inputs">2.4. Define Module Inputs</a>
<ul class="sectlevel3">
<li><a href="#_edit_variables_tf">2.4.1. Edit <code>variables.tf</code></a></li>
</ul>
</li>
<li><a href="#_implement_module_resources">2.5. Implement Module Resources</a>
<ul class="sectlevel3">
<li><a href="#_edit_main_tf">2.5.1. Edit <code>main.tf</code></a></li>
</ul>
</li>
<li><a href="#_define_module_outputs">2.6. Define Module Outputs</a>
<ul class="sectlevel3">
<li><a href="#_edit_outputs_tf">2.6.1. Edit <code>outputs.tf</code></a></li>
</ul>
</li>
<li><a href="#_test_module_locally">2.7. Test Module Locally</a>
<ul class="sectlevel3">
<li><a href="#_create_testing_file">2.7.1. Create Testing File</a></li>
<li><a href="#_edit_lab02main_tf">2.7.2. Edit <code>lab02/main.tf</code></a></li>
<li><a href="#_run_local_plan">2.7.3. Run Local Plan</a></li>
<li><a href="#_verification_3">2.7.4. Verification</a></li>
</ul>
</li>
<li><a href="#_cleanup_2">2.8. Cleanup</a></li>
<li><a href="#_troubleshooting_2">2.9. Troubleshooting</a></li>
<li><a href="#_review_2">2.10. Review</a></li>
</ul>
</li>
<li><a href="#_lab_testing_your_infrastructure_component">3. Lab: Testing Your Infrastructure Component</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites_and_setup_2">3.1. Prerequisites and Setup</a></li>
<li><a href="#_lab_scenario_ensuring_module_reliability">3.2. Lab Scenario: Ensuring Module Reliability</a></li>
<li><a href="#_create_test_structure">3.3. Create Test Structure</a>
<ul class="sectlevel3">
<li><a href="#_create_test_directory_and_file">3.3.1. Create Test Directory and File</a></li>
</ul>
</li>
<li><a href="#_define_basic_plan_test">3.4. Define Basic Plan Test</a>
<ul class="sectlevel3">
<li><a href="#_edit_sqs_secure_test_tftest_hcl">3.4.1. Edit <code>sqs_secure_test.tftest.hcl</code></a></li>
</ul>
</li>
<li><a href="#_apply_and_output_test">3.5. Apply and Output Test</a>
<ul class="sectlevel3">
<li><a href="#_add_apply_run_block">3.5.1. Add Apply Run Block</a></li>
</ul>
</li>
<li><a href="#_test_conditional_logic_dlq_disabled">3.6. Test Conditional Logic (DLQ Disabled)</a>
<ul class="sectlevel3">
<li><a href="#_add_dlq_disabled_test_run_block">3.6.1. Add DLQ Disabled Test Run Block</a></li>
</ul>
</li>
<li><a href="#_test_input_validation">3.7. Test Input Validation</a>
<ul class="sectlevel3">
<li><a href="#_add_validation_failure_test">3.7.1. Add Validation Failure Test</a></li>
</ul>
</li>
<li><a href="#_run_tests">3.8. Run Tests</a>
<ul class="sectlevel3">
<li><a href="#_execute_terraform_test">3.8.1. Execute <code>terraform test</code></a></li>
<li><a href="#_verification_4">3.8.2. Verification</a></li>
</ul>
</li>
<li><a href="#_cleanup_3">3.9. Cleanup</a></li>
<li><a href="#_troubleshooting_3">3.10. Troubleshooting</a></li>
<li><a href="#_review_3">3.11. Review</a></li>
</ul>
</li>
<li><a href="#_lab_automating_component_lifecycles">4. Lab: Automating Component Lifecycles</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites_and_setup_3">4.1. Prerequisites and Setup</a></li>
<li><a href="#_lab_scenario_sharing_and_automating_your_module">4.2. Lab Scenario: Sharing and Automating Your Module</a></li>
<li><a href="#_install_checkov_locally">4.3. Install Checkov Locally</a></li>
<li><a href="#_set_up_module_git_history">4.4. Set Up Module Git History</a></li>
<li><a href="#_create_ci_pipeline_with_github_actions">4.5. Create CI Pipeline with GitHub Actions</a>
<ul class="sectlevel3">
<li><a href="#_configure_github_secrets_for_aws_authentication">4.5.1. Configure GitHub Secrets for AWS Authentication</a></li>
<li><a href="#_create_workflow_file">4.5.2. Create Workflow File</a></li>
<li><a href="#_define_workflow_module_ci_yml">4.5.3. Define Workflow (<code>module-ci.yml</code>)</a></li>
<li><a href="#_commit_workflow_file">4.5.4. Commit Workflow File</a></li>
<li><a href="#_push_changes">4.5.5. Push Changes</a></li>
<li><a href="#_verification_5">4.5.6. Verification</a></li>
<li><a href="#_adjusting_ci_for_known_findings">4.5.7. Adjusting CI for Known Findings</a></li>
</ul>
</li>
<li><a href="#_version_and_publish_via_dedicated_repository">4.6. Version and Publish via Dedicated Repository</a>
<ul class="sectlevel3">
<li><a href="#_fork_the_dedicated_module_repository">4.6.1. Fork the Dedicated Module Repository</a></li>
<li><a href="#_create_version_tag_via_github_release">4.6.2. Create Version Tag via GitHub Release</a></li>
<li><a href="#_publish_module_manually_via_hcp_ui">4.6.3. Publish Module Manually via HCP UI</a></li>
</ul>
</li>
<li><a href="#_troubleshooting_4">4.7. Troubleshooting</a></li>
<li><a href="#_review_4">4.8. Review</a></li>
</ul>
</li>
<li><a href="#_lab_deploying_environments_managing_state">5. Lab: Deploying Environments &amp; Managing State</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites_and_setup_4">5.1. Prerequisites and Setup</a></li>
<li><a href="#_lab_scenario_managing_multiple_environments">5.2. Lab Scenario: Managing Multiple Environments</a></li>
<li><a href="#_create_environment_directories">5.3. Create Environment Directories</a></li>
<li><a href="#_create_and_configure_hcp_workspaces">5.4. Create and Configure HCP Workspaces</a>
<ul class="sectlevel3">
<li><a href="#_create_dev_sqs_workspace">5.4.1. Create 'dev-sqs' Workspace</a></li>
<li><a href="#_create_prod_sqs_workspace">5.4.2. Create 'prod-sqs' Workspace</a></li>
<li><a href="#_verification_6">5.4.3. Verification</a></li>
</ul>
</li>
<li><a href="#_define_environment_configurations">5.5. Define Environment Configurations</a>
<ul class="sectlevel3">
<li><a href="#_configure_devmain_tf">5.5.1. Configure <code>dev/main.tf</code></a></li>
<li><a href="#_configure_prodmain_tf">5.5.2. Configure <code>prod/main.tf</code></a></li>
</ul>
</li>
<li><a href="#_trigger_environment_deployments">5.6. Trigger Environment Deployments</a>
<ul class="sectlevel3">
<li><a href="#_trigger_initial_hcp_runs">5.6.1. Trigger Initial HCP Runs</a></li>
<li><a href="#_verification_7">5.6.2. Verification</a></li>
</ul>
</li>
<li><a href="#_cleanup_4">5.7. Cleanup</a></li>
<li><a href="#_troubleshooting_5">5.8. Troubleshooting</a></li>
<li><a href="#_review_5">5.9. Review</a></li>
</ul>
</li>
<li><a href="#_class_activity_collaborative_gitops_workflow_exploration">6. Class Activity: Collaborative GitOps Workflow Exploration</a></li>
<li><a href="#_class_activity_collaborative_security_compliance_workflow_showcase">7. Class Activity: Collaborative Security, Compliance &amp; Workflow Showcase</a></li>
<li><a href="#_class_activity_collaborative_refactoring_analysis">8. Class Activity: Collaborative Refactoring Analysis</a></li>
<li><a href="#">&nbsp;</a></li>
</ul>
        </nav>
      </div>
    </aside>
    <main class="document-content">
      
        
<section class="sect1">
  <header>
    <h2 id="_lab_setting_up_cloud_workflows">Lab: Setting Up Cloud Workflows</h2>
    
      <p class="subtitle">Module 1</p>
    
  </header>
  <div class="openblock objectives">
<div class="content">


<div class="ulist">
<ul>
<li>
Set up and connect to HCP Terraform Workspace with GitHub integration

</li>

<li>
Execute Terraform operations via Git-based and CLI-driven workflows

</li>

<li>
Explore state management and run history in the HCP UI

</li>

</ul>
</div>
</div>
</div>
<p>Estimated Time: 45-60 minutes (excluding initial tool setup)</p>

<section class="sect2">
  <header>
    <h3 id="_configure_your_environment">1.1. Configure Your Environment</h3>
    
  </header>
  <p>Prepare your lab machine and necessary accounts for the workshop labs. Make sure you use your Lab VM to do all labs instead of directly on your work machine.</p>

<section class="sect3">
  <header>
    <h4 id="_install_command_line_tools">1.1.1. Install Command-Line Tools</h4>
    
  </header>
  <p><strong><em>Start a terminal session inside your Lab VM.</em></strong> Install the following tools on your lab machine if they are not already present. Follow the official installation guides for your operating system.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Install Git:</strong> Git should already be installed. If not, visit <a href="https://git-scm.com/" class="bare">https://git-scm.com/</a> to install it or check with instructor.</p>


<div class="ulist">
<ul>
<li>
<strong>Verify:</strong> Open your terminal and run <code>git --version</code>.

</li>

</ul>
</div>
</li>
<li>
<p><strong>Install Terraform CLI:</strong> The core Terraform tool (latest stable recommended). As of April 2025, The following code block is for Ubuntu/Debian. Copy the <em>entire</em> code block and paste in terminal. Check with instructor for the machine password to use for <code>sudo</code> (try <code>wasadmin</code> first).  <strong><em>Note: If you get a screen asking you to restart any daemons or services, use <code>tab</code> key to select `Cancel`</em></strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="nb">sudo </span>apt update
wget <span class="nt">-O</span> - https://apt.releases.hashicorp.com/gpg | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /usr/share/keyrings/hashicorp-archive-keyring.gpg
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com </span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="s2"> main"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/hashicorp.list
<span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install </span>terraform</code></pre>
</div>
</div>


<div class="ulist">
<ul>
<li>
<strong>Verify:</strong> Open your terminal and run <code>terraform --version</code>.

</li>

</ul>
</div>
</li>
<li>
<p><strong>Install AWS CLI:</strong> You need to install the AWS CLI to configure AWS credentials locally for Terraform CLI. The following code block is for Ubuntu/Debian. Copy the <em>entire</em> code block and paste in terminal. Check with instructor for the machine password to use for <code>sudo</code> (try <code>wasadmin</code> first).</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell">curl <span class="s2">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> <span class="nt">-o</span> <span class="s2">"awscliv2.zip"</span>
unzip awscliv2.zip
<span class="nb">sudo</span> ./aws/install</code></pre>
</div>
</div>


<div class="ulist">
<ul>
<li>
<strong>Verify:</strong> Open your terminal and run <code>aws --version</code>.

</li>

</ul>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_set_up_accounts_and_log_in">1.1.2. Set Up Accounts and Log In</h4>
    
  </header>
  <p>DO THE FOLLOWING STEPS USING THE LAB VM: Create accounts for the following services if you don&#8217;t have them, and log in via your web browser <em>in your lab VM</em>. It is crucial you use the lab VM to do these steps so as to not conflict with your work browser sessions on your native machine.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>GitHub Account:</strong> Create a free account at GitHub.com. Log in to GitHub. <em>Make sure you use a personal email address for creating this account.</em> Do NOT use your work Github account or email address.</p>
</li>
<li>
<p><strong>HCP Terraform Account:</strong> Create a free tier account at <a href="https://app.terraform.io/signup/account" class="bare">https://app.terraform.io/signup/account</a>. Again, use your personal email address for this.  Log in to HCP Terraform.</p>
</li>
<li>
<p><strong>AWS Account:</strong> Access your AWS account. Use the course provided AWS credentials to log into AWS Console in your lab VM&#8217;s browser. Ensure you select the <code>us-west-2</code> region unless specified otherwise by the instructor.</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_create_and_configure_aws_credentials">1.1.3. Create and Configure AWS Credentials</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Create IAM User:</strong> In AWS Console &gt; IAM:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add user (e.g., <code>tf-local-cli-user</code>).</p>
</li>
<li>
<p>This user doesn&#8217;t need console access, so leave the option unchecked if asked.</p>
</li>
<li>
<p>For permissions, attach policies directly: <code>AdministratorAccess</code>. Since this is a sandbox lab, we&#8217;ll use full access for simplicity. In production, you would use least privilege policies.</p>
</li>
<li>
<p>Create user.</p>
</li>
<li>
<p>From user list, select new user and go to <strong>Security credentials</strong> tab &gt; <strong>Create access key</strong> &gt; Select <strong>CLI</strong> &gt; Check any confirmation boxes &gt; Next &gt; Click <strong>Create access key</strong></p>
</li>
<li>
<p>Save the <strong>Access key</strong> and <strong>Secret access key</strong> to a local text file. You will need these values later in this lab and some future labs (Tip: leave this page open for the rest of this lab so you can copy/paste the values for CLI and later for HCP Terraform configuration).</p>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Configure AWS CLI:</strong> Run <code>aws configure</code> in your lab VM&#8217;s terminal:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Enter <strong>Access Key ID</strong>, <strong>Secret Access Key</strong>, region (<code>us-west-2</code>), output (<code>json</code>).</p>
</li>
<li>
<p><em>Verify:</em> Run <code>aws sts get-caller-identity</code> to confirm successful configuration (you should see your IAM user details if successful)</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_configure_git">1.1.4. Configure Git</h4>
    
  </header>
  <p>Do the following in the Lab VM&#8217;s terminal.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Generate SSH key: <code>ssh-keygen -t ed25519 -C "<a href="mailto:your_personal_email@example.com">your_personal_email@example.com</a>"</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Replace <code>your_personal_email@example.com</code> with your actual personal email address.</p>
</li>
<li>
<p>Hit <code>Enter</code> for all prompts to select default answers.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Start SSH agent: <code>eval "$(ssh-agent -s)"</code></p>
</li>
<li>
<p>Add key to agent: <code>ssh-add ~/.ssh/id_ed25519</code></p>
</li>
<li>
<p>Copy public key displayed after the command: <code>cat ~/.ssh/id_ed25519.pub</code></p>
</li>
<li>
<p>In the browser, go to GitHub: Settings &gt; SSH and GPG keys &gt; New SSH key</p>
</li>
<li>
<p>Paste key, name it (e.g., "Lab VM"), select "Authentication Key", click "Add SSH key"</p>
</li>
<li>
<p>Back in the terminal, test connection: <code>ssh -T <a href="mailto:git@github.com">git@github.com</a></code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If asked to continue, type <code>yes</code>.</p>
</li>
<li>
<p>You should see a message like "Hi &lt;Your GitHub Username&gt;! You&#8217;ve successfully authenticated, but GitHub does not provide shell access."</p>
</li>
</ol>
</div>
</li>
<li>
<p>Configure git username: <code>git config --global user.name "Your Name"</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Replace <code>Your Name</code> with your actual name.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Configure git email: <code>git config --global user.email "<a href="mailto:your_personal_email@example.com">your_personal_email@example.com</a>"</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Replace <code>your_personal_email@example.com</code> with your actual personal email address.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_prepare_your_course_repository">1.1.5. Prepare Your Course Repository</h4>
    
  </header>
  <p>Set up the local repository for your lab work.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Fork the Starter Repository:</strong> In your lab VM&#8217;s browser, navigate to the <code>wa3581-starter</code> repository URL (<a href="https://github.com/InfraCodeOps/wa3581-starter.git" class="bare">https://github.com/InfraCodeOps/wa3581-starter.git</a>) on GitHub. Your instructor might provide you with a different source repository, in which case, use that instead. Click the <strong>Fork</strong> button to create a copy under your own GitHub account.</p>
</li>
<li>
<p><strong>Clone Your Fork:</strong> In your local terminal, clone <strong>your forked repository</strong>. Make sure to use the git SSH URL and replace &lt;Your_GitHub_Username&gt; with your actual username:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell">git clone git@github.com:&lt;Your_GitHub_Username&gt;/wa3581-starter.git
<span class="nb">cd </span>wa3581-starter</code></pre>
</div>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_set_up_vscode">1.1.6. Set up VSCode</h4>
    
  </header>
  <p>VS Code should already be installed in your Lab VM. If not, check with your instructor. You can always install it from <a href="https://code.visualstudio.com/" class="bare">https://code.visualstudio.com/</a>.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the cloned repository in VS Code.</p>
</li>
<li>
<p>Install the Hashicorp Terraform extension from the marketplace.</p>
</li>
<li>
<p>Ensure you have the terminal open within VSCode and that the present working directory is the base of the cloned repository.</p>
</li>
</ol>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_configure_hcp_organization_workspace_and_vcs_connection">1.2. Configure HCP Organization, Workspace and VCS Connection</h3>
    
  </header>
  <p>Let&#8217;s start by creating a new organization in your new HCP Terraform account. We will then add a workspace to this organization.</p>

<section class="sect3">
  <header>
    <h4 id="_create_a_new_organization">1.2.1. Create a New Organization</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In your lab VM&#8217;s browser, navigate to your HCP Terraform organization UI:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use the URL: <a href="https://app.terraform.io/app/organizations" class="bare">https://app.terraform.io/app/organizations</a></p>
</li>
</ol>
</div>
</li>
<li>
<p>Select the option to create a <strong>New organization</strong>.</p>
</li>
<li>
<p>Enter a name for your organization (e.g., <code>tf-advanced-labs-&lt;Your_GitHub_Username&gt;</code>).</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Organization names must be unique and cannot be changed after creation. Adding your Github username will likely make it unique.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click <strong>Create organization</strong>.</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_create_aws_credentials_variable_set">1.2.2. Create AWS Credentials Variable Set</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the <strong>Settings</strong> for the organization you just created.</p>
</li>
<li>
<p>Find the <strong>Variable Sets</strong> section and click on <strong>Create variable set</strong>.</p>
</li>
<li>
<p>Use <code>aws-credentials</code> as the name for the variable set.</p>
</li>
<li>
<p>Set scope to 'Apply to all projects and workspaces'</p>
</li>
<li>
<p>Add the following variables. <em>Note: You will need the access key details you used earlier. If you have that AWS Console page open, you can copy/paste the values. If not, create an additional access key for the same user.</em></p>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Category</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sensitive</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS_ACCESS_KEY_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Environment Variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;Your_AWS_Access_Key_ID&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS_SECRET_ACCESS_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Environment Variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;Your_AWS_Secret_Access_Key&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS_DEFAULT_REGION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Environment Variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">us-west-2</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Click the <code>Create variable set</code> button.</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_create_a_new_workspace">1.2.3. Create a New Workspace</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Within the organization you just created, navigate to the <strong>Workspaces</strong> section.</p>
</li>
<li>
<p>Select the option to create a <strong>New workspace</strong>.</p>
</li>
<li>
<p>Choose the <strong>Version control workflow</strong>.</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_connect_to_github_and_configure_workspace">1.2.4. Connect to GitHub and Configure Workspace</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Select the dropdown button labeled <strong>GitHub</strong> and choose <strong>GitHub.com</strong></p>
</li>
<li>
<p>Authorize HCP Terraform to access your repositories if prompted (this may involve a browser pop-up or redirection and you clicking the green button labeled <strong>Authorize Terraform Cloud</strong>).</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>You might get a "Failed to install GitHub App" error, depending on your browser. If so, disable pop-up and try above step again.. <em>In Chrome, you will see a pop-up blocker symbol in the URL bar to the right. Click on it, and choose "Always allow" option. Then try above step again"</em></p>
</li>
<li>
<p>On the "Install Terraform Cloud" page, select "All repositories" and click the green button labeled <strong>Install</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>You will now see the list of your repositories. Select the <code>wa3581-starter</code> repository that you forked earlier.</p>
</li>
<li>
<p><strong>Set Workspace Name:</strong> On the next screen, replace the default workspace name with <code>lab01</code>. Then expand <code>Advanced Options</code>.</p>
</li>
<li>
<p><strong>Set Terraform Working Directory:</strong> Under <code>Advanced Options</code>, set the <code>Terraform Working Directory</code> field to <code>lab01</code>. This tells HCP to operate within the <code>lab01</code> subdirectory of your repository.</p>
</li>
<li>
<p><strong>Set VCS Trigger Type:</strong> Ensure "Branch-based" is selected and leave the "VCS Branch" field empty (it will automatically select the default branch, which is usually <code>main</code>)</p>
</li>
<li>
<p>For <strong>Automatic Run triggering</strong>, select <code>Only trigger runs when files in specified paths change</code> &gt; <code>Patterns</code>. Enter <code>lab01/**</code> in the path field. <em>Make sure to click the <code>Add pattern</code> button.</em></p>
</li>
<li>
<p><strong>Confirm Automatic Speculative Plans:</strong> Ensure the "Automatic Speculative Plans" option is checked (usually default).</p>
</li>
<li>
<p><strong>Create the Workspace:</strong> Leave other options as they are and click the <strong>Create workspace</strong> button.</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_trigger_manual_run">1.2.5. Trigger Manual Run</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the workspace&#8217;s home page in your browser.</p>
</li>
<li>
<p>Select the <strong>Runs</strong> tab.</p>
</li>
<li>
<p>Click <strong>+ New Run</strong> button.</p>
</li>
<li>
<p>Change the <strong>Run Type</strong> to <code>Plan only</code>.</p>
</li>
<li>
<p>Click <strong>Start</strong>.</p>
</li>
<li>
<p>This will trigger our first manual run. This manual run is necessary before VCS-triggered runs can happen.</p>
</li>
<li>
<p>Since there is no code in the lab01 directory, as expected, HCP will fail the run. You should get a <strong>Plan errored</strong> message. That&#8217;s expected. Now we are set for VCS-triggered runs.</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_understanding_the_lab_repository_structure">1.2.6. Understanding the Lab Repository Structure</h4>
    
  </header>
  <p>For this course, all lab work happens within dedicated subdirectories (like <code>lab01/</code>, <code>lab02/</code>, etc.) inside a single main Git repository (<code>wa3581-starter</code>). You have created a personal fork of this repository and will be committing your work there.</p>
<p>Why this structure for the course?</p>


<div class="ulist">
<ul>
<li>
<strong>Simplicity:</strong> It keeps all course materials and your work in one place, making it easier to navigate and manage, especially when using checkpoints or referring to solutions.

</li>

<li>
<strong>Focus:</strong> It allows each lab to concentrate on specific Terraform concepts without adding the overhead of managing multiple separate repositories for each small task.

</li>

</ul>
</div>
<p>How does this relate to HCP Workspaces?</p>
<p>Earlier in this lab, when configuring the HCP Workspace, we set the <strong>Terraform Working Directory</strong> to <code>lab01/</code>. This tells HCP to <strong>only</strong> look for Terraform code and trigger runs based on changes within that specific subdirectory in your forked repository.</p>
<p>Real-World Comparison:</p>
<p>While convenient for this course, be aware that in typical production environments, an HCP Workspace often maps to:</p>


<div class="ulist">
<ul>
<li>
<strong>An entire dedicated repository:</strong> Often used in a <strong>polyrepo</strong> strategy where each repository manages a distinct service, layer, or component. The Working Directory in HCP would likely be the repository root. (e.g., A <code>networking-prod</code> workspace linked to a <code>company-networking.git</code> repository).

</li>

<li>
<strong>A major top-level directory within a monorepo:</strong> Representing a significant application or environment boundary. (e.g., A <code>payment-app-prod</code> workspace linked to <code>company-mono-repo.git</code> with the Working Directory set to <code>apps/payment-service/production/</code>).

</li>

</ul>
</div>
<p>Our lab setup simulates these patterns by focusing HCP&#8217;s attention on the specific <code>labXX/</code> subdirectory, allowing you to practice the VCS workflow effectively within the course&#8217;s simplified structure. Understanding this distinction is key when applying these concepts outside the lab environment.</p>
</section>

<section class="sect3">
  <header>
    <h4 id="_verification">1.2.7. Verification</h4>
    
  </header>
  <p>Your HCP Workspace is now set up and listening for changes in the <code>lab01</code> directory of your repository&#8217;s <code>main</code> branch. It also has the necessary AWS credentials configured via the <code>aws-credentials</code> variable set at the organization level.</p>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_trigger_run_via_vcs_workflow">1.3. Trigger Run via VCS Workflow</h3>
    
  </header>
  <p>Now, let&#8217;s add some basic Terraform code and push it to trigger the VCS workflow.</p>

<section class="sect3">
  <header>
    <h4 id="_define_initial_infrastructure">1.3.1. Define Initial Infrastructure</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In VSCode, navigate into the <code>lab01</code> directory within your cloned repository structure.</p>
</li>
<li>
<p>Create a file named <code>main.tf</code>.</p>
</li>
<li>
<p>Add the following Terraform configuration. The challenge is to add a simple AWS S3 bucket resource named <code>learning_bucket</code> with a globally unique name (Hint: use interpolation with a random suffix resource).</p>
</li>
</ol>
</div>
<p>Challenge Code Block:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">terraform</span> <span class="p">{</span>
  <span class="nx">required_providers</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/aws"</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 5.0"</span> <span class="c1">// Use an appropriate AWS provider version</span>
    <span class="p">}</span>
    <span class="nx">random</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/random"</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 3.1"</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1"># Backend is configured implicitly by HCP Terraform Workspace</span>
<span class="p">}</span>

<span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="o">=</span> <span class="s2">"us-west-2"</span> <span class="c1">// Ensure correct region</span>
<span class="p">}</span>

<span class="c1"># TODO: Add a random_string resource named "suffix"</span>
<span class="c1"># TODO: Add an aws_s3_bucket resource named "learning_bucket"</span>
<span class="c1">#       using the random suffix to ensure a unique name.</span>
<span class="c1">#       Add a tag: Name = "TF Advanced Lab 1 Bucket"</span></code></pre>
</div>
</div>
<p>Solution:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">terraform</span> <span class="p">{</span>
  <span class="nx">required_providers</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/aws"</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 5.0"</span> <span class="c1">// Use an appropriate AWS provider version</span>
    <span class="p">}</span>
    <span class="nx">random</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/random"</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 3.1"</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1"># Backend is configured implicitly by HCP Terraform Workspace</span>
<span class="p">}</span>

<span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="o">=</span> <span class="s2">"us-west-2"</span> <span class="c1">// Ensure correct region</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"random_string"</span> <span class="s2">"suffix"</span> <span class="p">{</span>
  <span class="nx">length</span>  <span class="o">=</span> <span class="mi">8</span>
  <span class="nx">special</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="nx">upper</span>   <span class="o">=</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"learning_bucket"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="s2">"tf-adv-lab01-${random_string.suffix.result}"</span> <span class="c1"># Construct unique name</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"TF Advanced Lab 1 Bucket"</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_commit_and_push_code">1.3.2. Commit and Push Code</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Stage, commit, and push your <code>main.tf</code> file to your GitHub repository&#8217;s <code>main</code> branch using Git commands. While you can run <code>git commit</code> and <code>git push</code> from the terminal, you can also do this in VSCode. In the terminal, you can run commit and push commands while being in any subdirectory. However, for simplicity of instructions, we will assume you are at the root of your repo (<code>wa3581-starter</code> directory) in the terminal when running git commands:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Assuming you are at the root of your repo (`wa3581-starter` directory)</span>
git add lab01/main.tf
git commit <span class="nt">-m</span> <span class="s2">"feat(lab01): Add initial S3 bucket"</span>
git push origin main</code></pre>
</div>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_observe_hcp_run">1.3.3. Observe HCP Run</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Switch back to your HCP Terraform Workspace UI in your browser.</p>
</li>
<li>
<p>Navigate to the <strong>Runs</strong> tab.</p>
</li>
<li>
<p>Observe the new run triggered by your push. Wait for it to complete the <code>plan</code> phase. (You should see a yellow <strong>Planned</strong> tag).</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_confirm_and_apply">1.3.4. Confirm and Apply</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Once the plan finishes successfully, click on the plan and review the plan output. It should show the S3 bucket and random string resources to be created.</p>
</li>
<li>
<p>Click <strong>Confirm &amp; Apply</strong>.</p>
</li>
<li>
<p>Add an optional comment if desired, then click <strong>Confirm Plan</strong>. HCP Terraform will now execute <code>terraform apply</code>.</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_verification_2">1.3.5. Verification</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Wait for the <code>apply</code> phase to complete successfully.</p>
</li>
<li>
<p>Navigate to the <strong>States</strong> tab in your HCP Workspace. Click on the state item listed (it will have the same label as your git commit message).</p>
</li>
<li>
<p>Observe the current state containing the new resources.</p>
</li>
<li>
<p>(Optional) Verify the S3 bucket exists in your AWS Console (<code>us-west-2</code> region).</p>
</li>
</ol>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_trigger_run_via_cli_workflow">1.4. Trigger Run via CLI Workflow</h3>
    
  </header>
  <p>Now, let&#8217;s interact with the same workspace using the local Terraform CLI.</p>

<section class="sect3">
  <header>
    <h4 id="_login_to_terraform_cloud">1.4.1. Login to Terraform Cloud</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In your terminal, authenticate your local CLI with your HCP Terraform account:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell">terraform login</code></pre>
</div>
</div>
</li>
<li>
<p>Follow the prompts: a browser window will open. Confirm the authorization and name the API token <code>terraform-course-cli</code> (keep expiration at 30 days). Copy the generated token.</p>
</li>
<li>
<p>Paste the API token back into your terminal when prompted. You might not see any characters in the terminal when you paste the token..</p>
</li>
<li>
<p>If successful, you will see a <strong>Welcome to HCP Terraform!</strong> message.</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_initialize_for_remote_backend">1.4.2. Initialize for Remote Backend</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In VSCode, open <code>lab01/main.tf</code> and add the <code>cloud</code> block within the <code>terraform</code> block. Your <code>terraform</code> block should look like this:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">terraform</span> <span class="p">{</span>
  <span class="nx">required_providers</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/aws"</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 5.0"</span> <span class="c1">// Use an appropriate AWS provider version</span>
    <span class="p">}</span>
    <span class="nx">random</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/random"</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 3.1"</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">cloud</span> <span class="p">{</span>
    <span class="nx">organization</span> <span class="o">=</span> <span class="s2">"tf-advanced-labs-&lt;Your_GitHub_Username&gt;"</span>
    <span class="nx">workspaces</span> <span class="p">{</span>
      <span class="nx">name</span> <span class="o">=</span> <span class="s2">"lab01"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>In the terminal, navigate to the <code>lab01</code> directory of your repository.</p>
</li>
<li>
<p>Run <code>terraform init</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the 'lab01' directory</span>
terraform init</code></pre>
</div>
</div>
</li>
<li>
<p>Observe the output stating <code>Initializing HCP Terraform&#8230;&#8203;</code></p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_run_plan_locally_executes_remotely">1.4.3. Run Plan Locally (Executes Remotely)</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Run <code>terraform plan</code> from the <code>lab01</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the 'lab01' directory</span>
terraform plan</code></pre>
</div>
</div>
</li>
<li>
<p>Notice the communication with HCP Terraform. The plan executes remotely and streams output locally. Verify it shows "No changes".  Optionally, check out the <code>runs</code> tab in your HCP Terraform Workspace to see this CLI triggered run</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_apply_not_allowed_throught_cli">1.4.4. Apply Not Allowed throught CLI</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In the terminal, run <code>terraform apply</code> from the <code>lab01</code> directory.</p>
</li>
<li>
<p>Notice that you get an error stating <code>Apply is not allowed for workspaces with a VCS connection</code>.  This is by design so as to ensure that the VCS remains the single source of truth.</p>
</li>
</ol>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_cleanup">1.5. Cleanup</h3>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In the HCP Terraform UI, navigate to your workspace (<code>lab01</code>).</p>
</li>
<li>
<p>Go to <strong>Settings &#8594; Destruction and Deletion</strong>.</p>
</li>
<li>
<p>Click <strong>Queue destroy plan</strong>, and enter workspace name (<code>lab01</code>)</p>
</li>
<li>
<p>Review the destroy plan. Click <strong>Confirm &amp; Apply</strong>.</p>
</li>
<li>
<p>(Optional) After destruction completes, you can delete the HCP Workspace via the same settings page.</p>
</li>
</ol>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_troubleshooting">1.6. Troubleshooting</h3>
    
  </header>
  

<div class="ulist">
<ul>
<li>
<strong>Authentication Errors:</strong> Ensure <code>terraform login</code> was successful. Check API token permissions in HCP settings if issues persist.

</li>

<li>
<strong>VCS Connection Issues:</strong> Verify repository name, branch, working directory (<code>lab01</code>), and permissions in HCP Workspace VCS settings. Ensure the HCP GitHub App/OAuth connection is authorized for your fork.

</li>

<li>
<strong>AWS Credential Errors:</strong> Double-check the <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> environment variables in the HCP Workspace variables section. Ensure they are marked sensitive and are correct.

</li>

<li>
<strong>Code Errors on Plan/Apply:</strong> Carefully read the Terraform error output (in HCP Run UI or local CLI). Check HCL syntax in <code>main.tf</code>.

</li>

<li>
<strong>State Lock Errors:</strong> If running commands quickly, you might encounter state locks. Wait a moment and retry. HCP manages locking automatically.

</li>

</ul>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_review">1.7. Review</h3>
    
  </header>
  <p>In this lab, you successfully:</p>


<div class="ulist">
<ul>
<li>
Configured an HCP Terraform Workspace integrated with GitHub for VCS-driven runs.

</li>

<li>
Triggered a remote plan and apply via a <code>git push</code> (VCS Workflow).

</li>

<li>
Authenticated your local Terraform CLI with HCP Terraform.

</li>

<li>
Initialized Terraform locally to use the remote HCP Workspace backend.

</li>

<li>
Triggered remote plan from your local CLI.

</li>

</ul>
</div>
</section>
</section>
      
        
<section class="sect1">
  <header>
    <h2 id="_lab_crafting_reusable_components">Lab: Crafting Reusable Components</h2>
    
      <p class="subtitle">Module 2</p>
    
  </header>
  <div class="openblock objectives">
<div class="content">


<div class="ulist">
<ul>
<li>
Create a reusable Terraform module with standard file structure

</li>

<li>
Define typed input variables with validation

</li>

<li>
Implement conditional AWS resources (SQS Queues, KMS Key)

</li>

<li>
Expose meaningful outputs

</li>

<li>
Test the module with a simple root configuration

</li>

</ul>
</div>
</div>
</div>
<p>Estimated Time: 60-75 minutes</p>

<section class="sect2">
  <header>
    <h3 id="_prerequisites_and_setup">2.1. Prerequisites and Setup</h3>
    
  </header>
  

<div class="ulist">
<ul>
<li>
<strong>Accounts:</strong> AWS Provider credentials configured locally (as done in Lab 1 setup).

</li>

<li>
<strong>Tools:</strong> Terraform CLI (latest stable version) installed, Git installed, Code Editor.

</li>

<li>
<strong>Repository:</strong> Working within your clone of the forked <code>wa3581-starter</code> repository.

</li>

<li>
<strong>Previous State:</strong> Lab 1 setup completed. Ensure your AWS credentials are still configured locally.

</li>

<li>
<strong>Verification:</strong> In your terminal, run <code>terraform --version</code> and <code>aws sts get-caller-identity</code>.

</li>

</ul>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_lab_scenario_building_a_secure_message_queue_component">2.2. Lab Scenario: Building a Secure Message Queue Component</h3>
    
  </header>
  <p>In many modern applications, different parts need to communicate without being directly connected. Imagine an e-commerce site: when an order is placed, the order service needs to tell the shipping service and the notification service. Instead of calling them directly (which could fail if one is busy), it can put a "message" into a queue. Other services pick up messages when ready. This is <strong>decoupling</strong>, and it makes systems more resilient.</p>


<div class="ulist">
<ul>
<li>
<strong>AWS Simple Queue Service (SQS):</strong> This is Amazon&#8217;s managed message queue service. It&#8217;s reliable and scalable. We&#8217;ll create a main SQS queue for our hypothetical application messages.

</li>

<li>
<strong>Handling Failed Messages (Dead Letter Queue - DLQ):</strong> What if a service tries to process a message but fails repeatedly (e.g., due to a bug or bad data)? This "poison pill" message could get stuck, blocking other messages. A common solution is a <strong>Dead Letter Queue (DLQ)</strong>. It&#8217;s a separate SQS queue where messages are automatically moved after failing processing a set number of times (defined by a <code>redrive_policy</code>). Developers can later inspect the DLQ to debug failed messages without impacting the main queue flow.

</li>

<li>
<strong>Security (AWS Key Management Service - KMS):</strong> Messages might contain sensitive data. We need to ensure they are encrypted when stored in the queue. <strong>AWS KMS</strong> provides managed encryption keys. We&#8217;ll create a dedicated KMS key and configure our SQS queues to use it for server-side encryption.

</li>

<li>
<strong>The Module&#8217;s Goal:</strong> Instead of configuring these related resources (Main Queue, optional DLQ, KMS Key, Redrive Policy) manually every time, we will build a reusable Terraform <strong>module</strong>. This module will encapsulate this "Secure SQS Queue with DLQ" pattern, making it easy, consistent, and less error-prone to deploy across different projects or environments. This lab focuses on building this robust, reusable component <strong>within the <code>lab02</code> directory</strong>.

</li>

</ul>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_create_module_structure">2.3. Create Module Structure</h3>
    
  </header>
  <p>We will create the module within the <code>lab02</code> directory to keep lab work self-contained.</p>

<section class="sect3">
  <header>
    <h4 id="_create_directories_and_files">2.3.1. Create Directories and Files</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In the terminal, navigate to the root of your cloned repository and create the necessary directories and empty files for the module <strong>inside</strong> the <code>lab02</code> folder:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the root of your repo clone</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> lab02/modules/sqs-secure
<span class="nb">touch </span>lab02/modules/sqs-secure/main.tf
<span class="nb">touch </span>lab02/modules/sqs-secure/variables.tf
<span class="nb">touch </span>lab02/modules/sqs-secure/outputs.tf</code></pre>
</div>
</div>
</li>
</ol>
</div>
<p>This standard layout separates the main logic, input variables, and output definitions for clarity within our module&#8217;s source directory (<code>lab02/modules/sqs-secure/</code>).</p>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_define_module_inputs">2.4. Define Module Inputs</h3>
    
  </header>
  <p>Let&#8217;s define the inputs our module will accept.</p>

<section class="sect3">
  <header>
    <h4 id="_edit_variables_tf">2.4.1. Edit <code>variables.tf</code></h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Open <code>lab02/modules/sqs-secure/variables.tf</code> in your code editor.</p>
</li>
<li>
<p>Add the following input variables.
Challenge: Define three variables:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>queue_name_prefix</code>: A string for the beginning of the queue names (e.g., "app-prod"). Add a description.</p>
</li>
<li>
<p><code>enable_dlq</code>: A boolean flag (defaulting to <code>true</code>) to control whether the Dead Letter Queue is created. Add a description.</p>
</li>
<li>
<p><code>tags</code>: A map of strings for applying common tags to resources. Default it to an empty map <code>{}</code> and add a description.
Bonus: Add a simple <code>validation</code> block to <code>queue_name_prefix</code> ensuring it&#8217;s not an empty string.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<p>Solution:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">variable</span> <span class="s2">"queue_name_prefix"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Prefix for the SQS queue names (e.g., 'app-prod'). Will be used for main and DLQ if enabled."</span>

  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span>     <span class="o">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">queue_name_prefix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="nx">error_message</span> <span class="o">=</span> <span class="s2">"The queue_name_prefix must not be empty."</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"enable_dlq"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">bool</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Set to true to create a Dead Letter Queue alongside the main SQS queue."</span>
  <span class="nx">default</span>     <span class="o">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"tags"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"A map of tags to apply to the SQS queues and KMS key."</span>
  <span class="nx">default</span>     <span class="o">=</span> <span class="p">{}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_implement_module_resources">2.5. Implement Module Resources</h3>
    
  </header>
  <p>Now, let&#8217;s define the AWS resources within the module.</p>

<section class="sect3">
  <header>
    <h4 id="_edit_main_tf">2.5.1. Edit <code>main.tf</code></h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Open <code>lab02/modules/sqs-secure/main.tf</code> in your code editor.</p>
</li>
<li>
<p>Add the following resources.
Challenge: Add the following resources:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An <code>aws_kms_key</code> resource named <code>sqs_key</code>. Enable key rotation. Use the input <code>tags</code>.</p>
</li>
<li>
<p>An <code>aws_sqs_queue</code> resource named <code>dlq</code> for the Dead Letter Queue.</p>


<div class="ulist">
<ul>
<li>
Set its name using the <code>queue_name_prefix</code> variable and appending <code>-dlq</code>.

</li>

<li>
Use the <code>count</code> meta-argument: create it only if <code>var.enable_dlq</code> is <code>true</code>. (Hint: <code>count = var.enable_dlq ? 1 : 0</code>).

</li>

<li>
Reference the KMS key created earlier for <code>kms_master_key_id</code>.

</li>

<li>
Add the input <code>tags</code>.

</li>

</ul>
</div>
</li>
<li>
<p>An <code>aws_sqs_queue</code> resource named <code>main</code> for the main queue.</p>


<div class="ulist">
<ul>
<li>
Set its name using the <code>queue_name_prefix</code> variable.

</li>

<li>
Reference the KMS key.

</li>

<li>
Configure its <code>redrive_policy</code>. This requires JSON configuration. The <code>redrive_policy</code> should only be configured <strong>if</strong> the DLQ is enabled (<code>var.enable_dlq == true</code>).

</li>

<li>
Inside the policy, set <code>deadLetterTargetArn</code> to the ARN of the DLQ created earlier. Remember the DLQ might not exist, so handle accessing its ARN carefully (Hint: Use the splat expression <code>aws_sqs_queue.dlq[*].arn</code> which yields an empty list if count=0, or use conditional logic <code>aws_sqs_queue.dlq[0].arn</code>).

</li>

<li>
Set <code>maxReceiveCount</code> to a reasonable value (e.g., 5).

</li>

<li>
Add the input <code>tags</code>.

</li>

</ul>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<p>Solution:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">resource</span> <span class="s2">"aws_kms_key"</span> <span class="s2">"sqs_key"</span> <span class="p">{</span>
  <span class="nx">description</span>             <span class="o">=</span> <span class="s2">"KMS key for encrypting ${var.queue_name_prefix} SQS queues"</span>
  <span class="nx">enable_key_rotation</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">tags</span>                  <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">tags</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_sqs_queue"</span> <span class="s2">"dlq"</span> <span class="p">{</span>
  <span class="c1"># Create this resource only if enable_dlq is true</span>
  <span class="nx">count</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_dlq</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>

  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"${var.queue_name_prefix}-dlq"</span>
  <span class="nx">kms_master_key_id</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">sqs_key</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">tags</span>              <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">tags</span>
  <span class="c1"># Consider adding message retention period, etc.</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_sqs_queue"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">queue_name_prefix</span>
  <span class="nx">kms_master_key_id</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">sqs_key</span><span class="p">.</span><span class="nx">arn</span>

  <span class="c1"># Configure redrive policy ONLY if DLQ is enabled</span>
  <span class="c1"># Note: Using dynamic configuration or conditional logic avoids errors when DLQ is disabled.</span>
  <span class="c1"># Here, we use a conditional expression for the attribute value.</span>
  <span class="nx">redrive_policy</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_dlq</span> <span class="o">?</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">deadLetterTargetArn</span> <span class="o">=</span> <span class="nx">aws_sqs_queue</span><span class="p">.</span><span class="nx">dlq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">arn</span> <span class="c1"># Access the single DLQ instance ARN</span>
    <span class="nx">maxReceiveCount</span>     <span class="o">=</span> <span class="mi">5</span>
  <span class="p">})</span> <span class="o">:</span> <span class="kc">null</span> <span class="c1"># Set to null if DLQ is disabled</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">tags</span>
  <span class="c1"># Consider adding other queue attributes like visibility_timeout_seconds</span>
<span class="p">}</span></code></pre>
</div>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_define_module_outputs">2.6. Define Module Outputs</h3>
    
  </header>
  <p>Expose useful information from the created resources.</p>

<section class="sect3">
  <header>
    <h4 id="_edit_outputs_tf">2.6.1. Edit <code>outputs.tf</code></h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Open <code>lab02/modules/sqs-secure/outputs.tf</code> in your code editor.</p>
</li>
<li>
<p>Define outputs for the following values.
Challenge: Define outputs for:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>main_queue_arn</code>: The ARN of the main SQS queue. Add a description.</p>
</li>
<li>
<p><code>main_queue_url</code>: The URL of the main SQS queue. Add a description.</p>
</li>
<li>
<p><code>dlq_arn</code>: The ARN of the Dead Letter Queue. This should only output a value if the DLQ was created. Handle the case where it might not exist (Hint: Use splat <code>[*]</code>, list indexing <code>[0]</code>, or conditional <code>try()</code>). Add a description.</p>
</li>
<li>
<p><code>kms_key_arn</code>: The ARN of the KMS key. Add a description.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<p>Solution:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">output</span> <span class="s2">"main_queue_arn"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The ARN of the main SQS queue."</span>
  <span class="nx">value</span>       <span class="o">=</span> <span class="nx">aws_sqs_queue</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="nx">output</span> <span class="s2">"main_queue_url"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The URL of the main SQS queue."</span>
  <span class="nx">value</span>       <span class="o">=</span> <span class="nx">aws_sqs_queue</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span> <span class="c1"># URL is stored in the 'id' attribute for SQS queue</span>
<span class="p">}</span>

<span class="nx">output</span> <span class="s2">"dlq_arn"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The ARN of the Dead Letter Queue (DLQ), if created."</span>
  <span class="c1"># Use try() to gracefully return null if the DLQ doesn't exist (count=0)</span>
  <span class="nx">value</span>       <span class="o">=</span> <span class="nx">try</span><span class="p">(</span><span class="nx">aws_sqs_queue</span><span class="p">.</span><span class="nx">dlq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">arn</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">output</span> <span class="s2">"kms_key_arn"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The ARN of the KMS key used for queue encryption."</span>
  <span class="nx">value</span>       <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">sqs_key</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span></code></pre>
</div>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_test_module_locally">2.7. Test Module Locally</h3>
    
  </header>
  <p>Let&#8217;s create a simple root configuration <strong>within the <code>lab02</code> directory</strong> to call our local module and ensure it plans correctly.</p>

<section class="sect3">
  <header>
    <h4 id="_create_testing_file">2.7.1. Create Testing File</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In the terminal, navigate to the <code>lab02</code> directory and create a new file named <code>main.tf</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the 'lab02' directory</span>
<span class="nb">touch </span>main.tf</code></pre>
</div>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_edit_lab02main_tf">2.7.2. Edit <code>lab02/main.tf</code></h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Open <code>lab02/main.tf</code> in your code editor.</p>
</li>
<li>
<p>Add configuration to call your new module.
Challenge: Add:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A <code>terraform</code> block with required providers (<code>aws</code>, <code>random</code>).</p>
</li>
<li>
<p>An <code>aws</code> provider block (use <code>us-west-2</code>).</p>
</li>
<li>
<p>A <code>module</code> block named <code>secure_queue_test</code> that calls your local module using the relative path <code>./modules/sqs-secure</code>.</p>
</li>
<li>
<p>Provide values for the required module inputs (<code>queue_name_prefix</code>, maybe override <code>enable_dlq</code>, <code>tags</code>).</p>
</li>
<li>
<p>Add <code>output</code> blocks in this root file to display the outputs coming <strong>from the module call</strong>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<p>Solution:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">terraform</span> <span class="p">{</span>
  <span class="nx">required_providers</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/aws"</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 5.0"</span>
    <span class="p">}</span>
    <span class="c1"># Random provider might be needed if module uses it (e.g., for unique names)</span>
    <span class="c1"># It wasn't strictly needed by the SQS module itself, but good practice</span>
    <span class="c1"># if sub-components might need randomness. Let's assume it might be needed.</span>
     <span class="nx">random</span> <span class="o">=</span> <span class="p">{</span>
       <span class="nx">source</span> <span class="o">=</span> <span class="s2">"hashicorp/random"</span>
       <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 3.1"</span>
     <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="o">=</span> <span class="s2">"us-west-2"</span> <span class="c1">// Ensure correct region</span>
<span class="p">}</span>

<span class="nx">module</span> <span class="s2">"secure_queue_test"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="s2">"./modules/sqs-secure"</span> <span class="c1"># Relative path to local module within lab02</span>

  <span class="nx">queue_name_prefix</span> <span class="o">=</span> <span class="s2">"adv-tf-lab02-test"</span>
  <span class="nx">enable_dlq</span>        <span class="o">=</span> <span class="kc">true</span> <span class="c1"># Explicitly enable for testing</span>
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="s2">"lab02-test"</span>
    <span class="nx">Project</span>     <span class="o">=</span> <span class="s2">"Advanced TF Course"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">output</span> <span class="s2">"test_main_queue_arn"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Output from the test module call: Main Queue ARN"</span>
  <span class="nx">value</span>       <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">secure_queue_test</span><span class="p">.</span><span class="nx">main_queue_arn</span>
<span class="p">}</span>

<span class="nx">output</span> <span class="s2">"test_main_queue_url"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Output from the test module call: Main Queue URL"</span>
  <span class="nx">value</span>       <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">secure_queue_test</span><span class="p">.</span><span class="nx">main_queue_url</span>
<span class="p">}</span>

<span class="nx">output</span> <span class="s2">"test_dlq_arn"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Output from the test module call: DLQ ARN"</span>
  <span class="nx">value</span>       <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">secure_queue_test</span><span class="p">.</span><span class="nx">dlq_arn</span>
<span class="p">}</span>

<span class="nx">output</span> <span class="s2">"test_kms_key_arn"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Output from the test module call: KMS Key ARN"</span>
  <span class="nx">value</span>       <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">secure_queue_test</span><span class="p">.</span><span class="nx">kms_key_arn</span>
<span class="p">}</span></code></pre>
</div>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_run_local_plan">2.7.3. Run Local Plan</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate your terminal into the <code>lab02</code> directory.</p>
</li>
<li>
<p>Run <code>terraform init</code>.</p>
</li>
<li>
<p>Run <code>terraform validate</code>.</p>
</li>
<li>
<p>Run <code>terraform plan</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the 'lab02' directory</span>
terraform init
terraform validate
terraform plan</code></pre>
</div>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_verification_3">2.7.4. Verification</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Check that <code>terraform validate</code> executes successfully without errors.</p>
</li>
<li>
<p>Check that the <code>plan</code> executes successfully without errors.</p>
</li>
<li>
<p>Review the plan output: It should propose creating the KMS key, the main SQS queue, and the DLQ (since <code>enable_dlq</code> was true).</p>
</li>
<li>
<p>Verify the planned outputs section shows values derived from the planned resources.</p>
</li>
<li>
<p>(Optional) Run <code>terraform apply</code> and <code>terraform destroy</code> locally within the <code>lab02</code> directory to verify resource creation/deletion (ensure cleanup!).</p>
</li>
</ol>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_cleanup_2">2.8. Cleanup</h3>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>If you ran <code>terraform apply</code> locally in the <code>lab02</code> directory, run <code>terraform destroy</code> from the same directory to remove the test resources.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the 'lab02' directory</span>
terraform destroy</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm the destruction by typing <code>yes</code>.</p>
</li>
</ol>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_troubleshooting_2">2.9. Troubleshooting</h3>
    
  </header>
  

<div class="ulist">
<ul>
<li>
<strong>Relative Path Errors:</strong> Ensure the <code>source</code> path in <code>lab02/main.tf</code> correctly points to <code>./modules/sqs-secure</code>. Check for typos.

</li>

<li>
<strong>Missing Variable Errors:</strong> Double-check that all required variables in <code>modules/sqs-secure/variables.tf</code> (only <code>queue_name_prefix</code> in this case) are provided in the <code>module "secure_queue_test"</code> block in <code>lab02/main.tf</code>.

</li>

<li>
<strong>Conditional Logic Errors:</strong> Pay close attention to the <code>count</code> for the DLQ and the conditional <code>redrive_policy</code> in <code>modules/sqs-secure/main.tf</code>. Test with <code>enable_dlq = false</code> in <code>lab02/main.tf</code> and run <code>plan</code> again to verify it handles that case correctly.

</li>

<li>
<strong>ARN Access Errors:</strong> Ensure you are accessing ARNs correctly, especially for conditionally created resources (e.g., <code>aws_sqs_queue.dlq[0].arn</code>). Using <code>try()</code> in outputs helps prevent errors when the resource doesn&#8217;t exist.

</li>

<li>
<strong>Provider Errors:</strong> Ensure your AWS credentials configured locally are valid and have permissions for SQS and KMS in <code>us-west-2</code>.

</li>

</ul>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_review_2">2.10. Review</h3>
    
  </header>
  <p>In this lab, you successfully:</p>


<div class="ulist">
<ul>
<li>
Created the standard file structure for a reusable Terraform module within the lab directory.

</li>

<li>
Defined module inputs (<code>variables.tf</code>) with types, defaults, descriptions, and validation.

</li>

<li>
Implemented conditionally created resources (<code>count</code>) within the module (<code>main.tf</code>).

</li>

<li>
Handled dependencies between resources within the module (KMS key used by queues).

</li>

<li>
Defined module outputs (<code>outputs.tf</code>), handling potentially non-existent resources gracefully (<code>try()</code>).

</li>

<li>
Tested the local module by calling it from a simple root configuration (<code>lab02/main.tf</code>) within the same lab directory.

</li>

</ul>
</div>
</section>
</section>
      
        
<section class="sect1">
  <header>
    <h2 id="_lab_testing_your_infrastructure_component">Lab: Testing Your Infrastructure Component</h2>
    
      <p class="subtitle">Module 3</p>
    
  </header>
  <div class="openblock objectives">
<div class="content">


<div class="ulist">
<ul>
<li>
Create and structure Terraform tests

</li>

<li>
Define test scenarios with <code>run</code> and <code>assert</code> blocks

</li>

<li>
Test module behavior with conditional logic and input validation

</li>

<li>
Execute tests with the <code>terraform test</code> command

</li>

</ul>
</div>
</div>
</div>
<p>Estimated Time: 60-75 minutes</p>

<section class="sect2">
  <header>
    <h3 id="_prerequisites_and_setup_2">3.1. Prerequisites and Setup</h3>
    
  </header>
  

<div class="ulist">
<ul>
<li>
<strong>Accounts:</strong> AWS Provider credentials configured locally (as done in Lab 1 setup).

</li>

<li>
<strong>Tools:</strong> Terraform CLI (ensure it supports <code>terraform test</code>, v1.6.0+ recommended) installed, Git installed, Code Editor.

</li>

<li>
<strong>Repository:</strong> Working within your clone of the forked <code>wa3581-starter</code> repository, specifically inside the <code>lab03</code> directory.

</li>

<li>
<strong>Previous State:</strong> Assumes Lab 2 was successfully completed and its resulting code exists within the <code>lab03</code> starter directory (module at <code>lab03/modules/sqs-secure/</code>, test harness at <code>lab03/main.tf</code>). Alternatively, check out the <code>lab2-complete</code> tag from the course solutions repository into your <code>lab03</code> directory <strong>before starting</strong>.

</li>

<li>
<strong>Verification:</strong> Navigate to the <code>lab03</code> directory in your terminal. Run <code>terraform --version</code> to confirm a compatible version. Run <code>aws sts get-caller-identity --region us-west-2</code>. Ensure the <code>modules/sqs-secure/</code> subdirectory exists with the <code>.tf</code> files from Lab 2.

</li>

</ul>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_lab_scenario_ensuring_module_reliability">3.2. Lab Scenario: Ensuring Module Reliability</h3>
    
  </header>
  <p>In the previous lab, we built a reusable module (<code>sqs-secure</code>) within the <code>lab2</code> directory (now copied to <code>lab03</code>). How do we ensure it actually works as expected, especially as we (or others) make changes to it over time? Manually testing by deploying infrastructure for every change is slow, expensive, and error-prone.</p>
<p>Automated testing provides a safety net. The <code>terraform test</code> command allows us to write tests in familiar HCL syntax to verify our module&#8217;s behavior under different conditions <strong>before</strong> we publish or use it in production. These tests check:</p>


<div class="ulist">
<ul>
<li>
Does it <code>plan</code> successfully with valid inputs?

</li>

<li>
Does it <code>apply</code> successfully?

</li>

<li>
Are the outputs correct after applying?

</li>

<li>
Does conditional logic (like enabling/disabling the DLQ) work?

</li>

<li>
Do input validation rules prevent invalid configurations?

</li>

</ul>
</div>
<p>This lab focuses on writing these automated tests for our <code>sqs-secure</code> module located at <code>lab03/modules/sqs-secure/</code>.</p>
</section>

<section class="sect2">
  <header>
    <h3 id="_create_test_structure">3.3. Create Test Structure</h3>
    
  </header>
  <p>Terraform tests typically reside in a <code>tests</code> subdirectory within the module being tested.</p>

<section class="sect3">
  <header>
    <h4 id="_create_test_directory_and_file">3.3.1. Create Test Directory and File</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In the terminal, navigate to the <code>lab03</code> directory (which contains <code>modules/</code>) and create the test directory and an empty test file <strong>within the module&#8217;s path</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the 'lab03' directory</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> modules/sqs-secure/tests
<span class="nb">touch </span>modules/sqs-secure/tests/sqs_secure_test.tftest.hcl</code></pre>
</div>
</div>
</li>
</ol>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_define_basic_plan_test">3.4. Define Basic Plan Test</h3>
    
  </header>
  <p>Start with a test to confirm the module’s plan runs successfully with default inputs.</p>

<section class="sect3">
  <header>
    <h4 id="_edit_sqs_secure_test_tftest_hcl">3.4.1. Edit <code>sqs_secure_test.tftest.hcl</code></h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Open <code>lab03/modules/sqs-secure/tests/sqs_secure_test.tftest.hcl</code> in your code editor.</p>
</li>
<li>
<p>Add these elements:</p>


<div class="ulist">
<ul>
<li>
A <code>variables</code> block with only the required <code>queue_name_prefix</code> (e.g., "lab03-test-defaults"). Note <code>enable_dlq</code> and <code>tags</code> use module defaults.

</li>

<li>
A <code>run</code> block named <code>plan_default_settings</code> with <code>command = plan</code>. No assertions needed—success means the plan executes without errors.

</li>

</ul>
</div>
</li>
</ol>
</div>
<p>Solution:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">variables</span> <span class="p">{</span>
  <span class="nx">queue_name_prefix</span> <span class="o">=</span> <span class="s2">"lab03-test-defaults"</span>
  <span class="c1"># enable_dlq defaults to true in the module</span>
  <span class="c1"># tags defaults to {} in the module</span>
<span class="p">}</span>

<span class="nx">run</span> <span class="s2">"plan_default_settings"</span> <span class="p">{</span>
  <span class="nx">command</span> <span class="o">=</span> <span class="nx">plan</span>
  <span class="c1"># No assert needed; success means plan executes without errors</span>
<span class="p">}</span></code></pre>
</div>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_apply_and_output_test">3.5. Apply and Output Test</h3>
    
  </header>
  <p>Next, test applying the resources and validating the module&#8217;s outputs.</p>

<section class="sect3">
  <header>
    <h4 id="_add_apply_run_block">3.5.1. Add Apply Run Block</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In <code>lab03/modules/sqs-secure/tests/sqs_secure_test.tftest.hcl</code>, append a second <code>run</code> block after the first.</p>


<div class="ulist">
<ul>
<li>
Add a <code>run</code> block named <code>apply_and_check_outputs</code>:

</li>

<li>
Set <code>command = apply</code>.

</li>

<li>
Add multiple <code>assert</code> conditions to verify:


<div class="ulist">
<ul>
<li>
<code>main_queue_arn</code> output is not null and starts with <code>arn:aws:sqs:</code>.

</li>

<li>
<code>kms_key_arn</code> output is not null and starts with <code>arn:aws:kms:</code>.

</li>

<li>
Since <code>enable_dlq</code> defaults to true, <code>dlq_arn</code> output should not be null and start with <code>arn:aws:sqs:</code>.

</li>

</ul>
</div>
</li>

</ul>
</div>
</li>
</ol>
</div>
<p>Solution:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">run</span> <span class="s2">"apply_and_check_outputs"</span> <span class="p">{</span>
  <span class="nx">command</span> <span class="o">=</span> <span class="nx">apply</span>

  <span class="nx">assert</span> <span class="p">{</span>
    <span class="nx">condition</span>     <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">main_queue_arn</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">output</span><span class="p">.</span><span class="nx">main_queue_arn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="p">==</span> <span class="s2">"arn:aws:sqs:"</span>
    <span class="nx">error_message</span> <span class="o">=</span> <span class="s2">"Main queue ARN should be a valid SQS ARN."</span>
  <span class="p">}</span>
  <span class="nx">assert</span> <span class="p">{</span>
    <span class="nx">condition</span>     <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">kms_key_arn</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">output</span><span class="p">.</span><span class="nx">kms_key_arn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="p">==</span> <span class="s2">"arn:aws:kms:"</span>
    <span class="nx">error_message</span> <span class="o">=</span> <span class="s2">"KMS key ARN should be a valid KMS ARN."</span>
  <span class="p">}</span>
  <span class="nx">assert</span> <span class="p">{</span>
    <span class="c1"># DLQ is enabled by default, so its ARN should be present</span>
    <span class="nx">condition</span>     <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">dlq_arn</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">output</span><span class="p">.</span><span class="nx">dlq_arn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="p">==</span> <span class="s2">"arn:aws:sqs:"</span>
    <span class="nx">error_message</span> <span class="o">=</span> <span class="s2">"DLQ ARN should be a valid SQS ARN when DLQ is enabled."</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_test_conditional_logic_dlq_disabled">3.6. Test Conditional Logic (DLQ Disabled)</h3>
    
  </header>
  <p>Test the module’s behavior when the DLQ is disabled, ensuring resources and outputs reflect this.</p>

<section class="sect3">
  <header>
    <h4 id="_add_dlq_disabled_test_run_block">3.6.1. Add DLQ Disabled Test Run Block</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In <code>lab03/modules/sqs-secure/tests/sqs_secure_test.tftest.hcl</code>, append a third <code>run</code> block.</p>


<div class="ulist">
<ul>
<li>
Add a <code>run</code> block named <code>apply_dlq_disabled</code>:

</li>

<li>
Set <code>command = apply</code>.

</li>

<li>
Include an inner <code>variables</code> block:


<div class="ulist">
<ul>
<li>
<code>queue_name_prefix</code> should be set to "lab03-test-no-dlq"

</li>

<li>
<code>enable_dlq</code> should be set to <code>false</code>.

</li>

</ul>
</div>
</li>

<li>
Add <code>assert</code> conditions to confirm:


<div class="ulist">
<ul>
<li>
<code>aws_sqs_queue.dlq</code> list length is 0 (due to <code>count = 0</code>).

</li>

<li>
<code>output.dlq_arn</code> is null.

</li>

<li>
Main queue exists with the specified name.

</li>

<li>
KMS key is still created.

</li>

</ul>
</div>
</li>

</ul>
</div>
</li>
</ol>
</div>
<p>Solution:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">run</span> <span class="s2">"apply_dlq_disabled"</span> <span class="p">{</span>
  <span class="nx">command</span> <span class="o">=</span> <span class="nx">apply</span>
  <span class="nx">variables</span> <span class="p">{</span>
    <span class="nx">queue_name_prefix</span> <span class="o">=</span> <span class="s2">"lab03-test-no-dlq"</span>
    <span class="nx">enable_dlq</span>        <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span>
  <span class="nx">assert</span> <span class="p">{</span>
    <span class="nx">condition</span>     <span class="o">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">aws_sqs_queue</span><span class="p">.</span><span class="nx">dlq</span><span class="p">)</span> <span class="p">==</span> <span class="mi">0</span>
    <span class="nx">error_message</span> <span class="o">=</span> <span class="s2">"DLQ should be an empty list when enable_dlq is false"</span>
  <span class="p">}</span>
  <span class="nx">assert</span> <span class="p">{</span>
    <span class="nx">condition</span>     <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">dlq_arn</span> <span class="o">==</span> <span class="kc">null</span>
    <span class="nx">error_message</span> <span class="o">=</span> <span class="s2">"DLQ ARN output should be null when enable_dlq is false"</span>
  <span class="p">}</span>
  <span class="nx">assert</span> <span class="p">{</span>
    <span class="nx">condition</span>     <span class="o">=</span> <span class="nx">aws_sqs_queue</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">"lab03-test-no-dlq"</span>
    <span class="nx">error_message</span> <span class="o">=</span> <span class="s2">"Main queue should be created with correct name"</span>
  <span class="p">}</span>
  <span class="nx">assert</span> <span class="p">{</span>
    <span class="nx">condition</span>     <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">sqs_key</span><span class="p">.</span><span class="nx">arn</span> <span class="o">!=</span> <span class="kc">null</span>
    <span class="nx">error_message</span> <span class="o">=</span> <span class="s2">"KMS key should be created"</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_test_input_validation">3.7. Test Input Validation</h3>
    
  </header>
  <p>Verify the module’s validation rejects an empty <code>queue_name_prefix</code>.</p>

<section class="sect3">
  <header>
    <h4 id="_add_validation_failure_test">3.7.1. Add Validation Failure Test</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In <code>lab03/modules/sqs-secure/tests/sqs_secure_test.tftest.hcl</code>, append a final <code>run</code> block.</p>


<div class="ulist">
<ul>
<li>
Add a <code>run</code> block named <code>fail_on_empty_prefix</code>:

</li>

<li>
Include an inner <code>variables</code> block setting <code>queue_name_prefix = ""</code>.

</li>

<li>
Set <code>command = plan</code>.

</li>

<li>
Use <code>expect_failures</code> with the variable reference to catch the validation error (<code>The queue_name_prefix must not be empty.</code>).

</li>

</ul>
</div>
</li>
</ol>
</div>
<p>Solution:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">run</span> <span class="s2">"fail_on_empty_prefix"</span> <span class="p">{</span>
  <span class="nx">variables</span> <span class="p">{</span>
    <span class="nx">queue_name_prefix</span> <span class="o">=</span> <span class="s2">""</span>
  <span class="p">}</span>
  <span class="nx">command</span> <span class="o">=</span> <span class="nx">plan</span>

  <span class="nx">expect_failures</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">var</span><span class="p">.</span><span class="nx">queue_name_prefix</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre>
</div>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_run_tests">3.8. Run Tests</h3>
    
  </header>
  <p>Now execute all the defined tests.</p>

<section class="sect3">
  <header>
    <h4 id="_execute_terraform_test">3.8.1. Execute <code>terraform test</code></h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>In the terminal, navigate to the <code>lab03/modules/sqs-secure</code> directory.</p>
</li>
<li>
<p>Run <code>terraform init</code>.</p>
</li>
<li>
<p>Run the test command</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Make sure you are in the 'lab03/modules/sqs-secure' directory!</span>
terraform init
terraform <span class="nb">test</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_verification_4">3.8.2. Verification</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Observe the output from <code>terraform test</code>.</p>
</li>
<li>
<p>Check that Terraform executes each <code>run</code> block sequentially. Notice the creation and automatic destruction of temporary infrastructure for the <code>apply</code> commands.</p>
</li>
<li>
<p>Verify that all tests pass, including the <code>fail_on_empty_prefix</code> test (which passes <strong>because</strong> the command failed as expected).</p>
</li>
</ol>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_cleanup_3">3.9. Cleanup</h3>
    
  </header>
  <p>The <code>terraform test</code> command automatically cleans up (destroys) any real infrastructure created during <code>apply</code> steps within the tests. No manual cleanup is required for resources created <strong>by the tests themselves</strong>.</p>
</section>

<section class="sect2">
  <header>
    <h3 id="_troubleshooting_3">3.10. Troubleshooting</h3>
    
  </header>
  

<div class="ulist">
<ul>
<li>
<strong><code>terraform test</code> Command Not Found:</strong> Ensure you have Terraform v1.6.0 or later installed (<code>terraform --version</code>).

</li>

<li>
<strong>Assertion Failures:</strong> Read the error message carefully. It will show expected vs. actual values. Debug the <code>condition</code> logic in your test file (<code>sqs_secure_test.tftest.hcl</code>) or the corresponding module code (<code>main.tf</code>, <code>outputs.tf</code>). Pay attention to resource addresses (they will be prefixed with <code>module.test.</code>).

</li>

<li>
<strong>AWS Errors during Apply:</strong> Check your local AWS credentials (<code>aws configure list</code>, <code>aws sts get-caller-identity</code>). Ensure the IAM principal has permissions for KMS and SQS in <code>us-west-2</code>.

</li>

<li>
<strong><code>expect_failures</code> Test Failing:</strong> Make sure the string(s) listed in <code>expect_failures</code> <strong>exactly match</strong> (or are contained within) the error message produced by Terraform during the failed <code>plan</code>. Referencing <code>var.VARIABLE.validation[INDEX].error_message</code> is usually the most reliable way.

</li>

</ul>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_review_3">3.11. Review</h3>
    
  </header>
  <p>In this lab, you successfully:</p>


<div class="ulist">
<ul>
<li>
Created and structured a Terraform test file (<code>.tftest.hcl</code>).

</li>

<li>
Defined test inputs using <code>variables</code> blocks.

</li>

<li>
Executed both <code>plan</code> and <code>apply</code> commands within test <code>run</code> blocks.

</li>

<li>
Validated plan results, module outputs, and resource state using <code>assert</code>.

</li>

<li>
Tested module behavior with different input variables (<code>enable_dlq</code>).

</li>

<li>
Verified input validation rules using <code>expect_failures</code>.

</li>

<li>
Ran the test suite using the <code>terraform test</code> command.

</li>

</ul>
</div>
</section>
</section>
      
        
<section class="sect1">
  <header>
    <h2 id="_lab_automating_component_lifecycles">Lab: Automating Component Lifecycles</h2>
    
      <p class="subtitle">Module 4</p>
    
  </header>
  <div class="openblock objectives">
<div class="content">


<div class="ulist">
<ul>
<li>
Set up CI pipeline with GitHub Actions for Terraform module testing

</li>

<li>
Version modules with semantic Git tags

</li>

<li>
Publish to and consume from HCP Terraform Registry

</li>

<li>
Automate the module lifecycle from development to consumption

</li>

</ul>
</div>
</div>
</div>
<p>Estimated Time: 75-90 minutes</p>

<section class="sect2">
  <header>
    <h3 id="_prerequisites_and_setup_3">4.1. Prerequisites and Setup</h3>
    
  </header>
  

<div class="ulist">
<ul>
<li>
<strong>Accounts:</strong> HCP Terraform account, GitHub account. AWS Provider credentials configured locally.

</li>

<li>
<strong>Tools:</strong> Terraform CLI (v1.6.0+), Git, VSCode.

</li>

<li>
<strong>Repository:</strong> Working within your clone of the forked <code>wa3581-starter</code> repository, specifically inside the <code>lab04</code> directory.

</li>

<li>
<strong>Previous State:</strong> Assumes Lab 3 was successfully completed and its resulting code exists within the <code>lab04</code> starter directory (module at <code>lab04/modules/sqs-secure/</code> including tests, test harness at <code>lab04/main.tf</code>). Your HCP Workspace from Lab 1 (<code>lab01</code>) should still exist and be connected to your repository fork.

</li>

<li>
<strong>Verification:</strong> Navigate to the <code>lab04</code> directory in your terminal. Run <code>terraform --version</code>, <code>git status</code>, <code>aws sts get-caller-identity --region us-west-2</code>. Ensure the module code and tests exist in <code>lab04/modules/sqs-secure/</code>.

</li>

</ul>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_lab_scenario_sharing_and_automating_your_module">4.2. Lab Scenario: Sharing and Automating Your Module</h3>
    
  </header>
  <p>In the previous labs, we built and tested a reusable module (<code>sqs-secure</code>) locally. Now, how do we share this module reliably with other teams? How do we ensure that quality checks run automatically every time changes are proposed?</p>
<p>This lab addresses the <strong>module lifecycle</strong>:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Continuous Integration (CI):</strong> We&#8217;ll create a GitHub Actions workflow to automatically run formatting checks, validation, tests (<code>terraform test</code>), and security scans (<code>checkov</code>) whenever code changes are pushed or proposed via Pull Requests. This provides fast feedback and maintains quality.</p>
</li>
<li>
<p><strong>Versioning:</strong> We&#8217;ll assign a formal version number (e.g., <code>v1.0.0</code>) using Git tags, following Semantic Versioning principles to communicate the nature of changes.</p>
</li>
<li>
<p><strong>Publishing:</strong> We&#8217;ll push the version tag to GitHub, which (through the existing HCP VCS connection) triggers HCP Terraform to automatically ingest and publish this version of the module to your organization&#8217;s <strong>Private Module Registry</strong>.</p>
</li>
<li>
<p><strong>Consumption:</strong> We&#8217;ll update our local test configuration (<code>lab04/main.tf</code>) to use the module from the registry instead of the local path, demonstrating how consumers would use the published module with version constraints.</p>
</li>
</ol>
</div>
<p>This process establishes a robust, automated workflow for developing, validating, and sharing reusable infrastructure components.</p>
</section>

<section class="sect2">
  <header>
    <h3 id="_install_checkov_locally">4.3. Install Checkov Locally</h3>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the following command in the terminal to install Checkov:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> python3-pip <span class="o">&amp;&amp;</span> pip3 <span class="nb">install </span>checkov <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s1">'export PATH="$HOME/.local/bin:$PATH"'</span> <span class="o">&gt;&gt;</span> ~/.bashrc <span class="o">&amp;&amp;</span> <span class="nb">source</span> ~/.bashrc <span class="o">&amp;&amp;</span> checkov <span class="nt">--version</span></code></pre>
</div>
</div>
</li>
<li>
<p>If you have other terminal instances open, they will only recognize the new installation after you restart them or run <code>source ~/.bashrc</code> in them.</p>
</li>
</ol>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_set_up_module_git_history">4.4. Set Up Module Git History</h3>
    
  </header>
  <p>Although we&#8217;re working within a larger lab repository, we need to treat the module code as if it&#8217;s being versioned independently. We&#8217;ll stage and commit the current state of the module code.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Format Code:</strong> Before committing, run <code>terraform fmt</code> recursively from the <code>lab04</code> directory to ensure all Terraform files adhere to standard formatting. This prevents the CI check from failing unnecessarily.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the ROOT of your repository</span>
<span class="nb">cd </span>lab04
terraform <span class="nb">fmt</span> <span class="nt">-recursive</span>
<span class="nb">cd</span> .. <span class="c"># Go back to root</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Stage Module Files:</strong> Using the terminal, from the root directory of your repository, stage all files related to the <code>sqs-secure</code> module within the <code>lab04</code> directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the ROOT of your `wa3581-starter` repository</span>
git add lab04/modules/sqs-secure/
git add lab04/main.tf</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Commit Initial Module State:</strong> Create a commit representing the current, tested state of the module from Lab 3.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell">git commit <span class="nt">-m</span> <span class="s2">"feat(lab04/module): Add initial sqs-secure module code and tests"</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>*Note:* We commit from the root, but the message clarifies the change relates to the module within `lab04`.</pre>
</div>
</div>
</li>
</ol>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_create_ci_pipeline_with_github_actions">4.5. Create CI Pipeline with GitHub Actions</h3>
    
  </header>
  <p>Let&#8217;s define a workflow that runs our checks automatically. GitHub Actions workflows are defined in YAML files within the <code>.github/workflows/</code> directory at the <strong>root</strong> of the repository.</p>

<section class="sect3">
  <header>
    <h4 id="_configure_github_secrets_for_aws_authentication">4.5.1. Configure GitHub Secrets for AWS Authentication</h4>
    
  </header>
  <p>Our <code>terraform test</code> command includes <code>apply</code> steps, which will attempt to create real AWS resources temporarily. The GitHub Actions runner environment where our CI pipeline executes does not have access to your local AWS credentials. We need to provide credentials securely using GitHub Actions Secrets.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Navigate to GitHub Secrets:</strong> In your web browser, go to your forked repository on GitHub. Click on <strong>Settings</strong> &#8594; <strong>Secrets and variables</strong> (in the left sidebar) &#8594; <strong>Actions</strong>.</p>
</li>
<li>
<p><strong>Create Access Key Secret:</strong></p>


<div class="ulist">
<ul>
<li>
Click <strong>New repository secret</strong>.

</li>

<li>
Enter the Name: <code>AWS_ACCESS_KEY_ID</code>

</li>

<li>
Paste your AWS Access Key ID (the one you configured with <code>aws configure</code> in Lab 1) into the <strong>Secret</strong> field.

</li>

<li>
Click <strong>Add secret</strong>.

</li>

</ul>
</div>
</li>
<li>
<p><strong>Create Secret Key Secret:</strong></p>


<div class="ulist">
<ul>
<li>
Click <strong>New repository secret</strong> again.

</li>

<li>
Enter the Name: <code>AWS_SECRET_ACCESS_KEY</code>

</li>

<li>
Paste your AWS Secret Access Key (the one you configured with <code>aws configure</code> in Lab 1) into the <strong>Secret</strong> field.

</li>

<li>
Click <strong>Add secret</strong>.

</li>

</ul>
</div>
</li>
</ol>
</div>
<p>These secrets will allow the GitHub Actions workflow to authenticate to AWS securely during the test runs without exposing your credentials in the code or logs. We will reference these secrets in the workflow YAML file next.</p>
</section>

<section class="sect3">
  <header>
    <h4 id="_create_workflow_file">4.5.2. Create Workflow File</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Using the terminal, from the root directory of your repository, create the directories and an empty workflow file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the ROOT of your `wa3581-starter` repository</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> .github/workflows
<span class="nb">touch</span> .github/workflows/module-ci.yml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_define_workflow_module_ci_yml">4.5.3. Define Workflow (<code>module-ci.yml</code>)</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Open <code>.github/workflows/module-ci.yml</code> in your code editor.</p>
</li>
<li>
<p>Add the workflow definition based on the structure below. Read the comments carefully to understand each step&#8217;s purpose.
Challenge: Complete the <code>steps</code> for the <code>test</code> job:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use <code>actions/checkout@v4</code> to check out the code.</p>
</li>
<li>
<p>Use <code>hashicorp/setup-terraform@v3</code> to install Terraform.</p>
</li>
<li>
<p>Add a step to run <code>terraform fmt -check -recursive</code> from the <code>lab04</code> directory.</p>
</li>
<li>
<p>Add steps (running from the <code>lab04</code> directory) to initialize (<code>terraform init</code>) and validate (<code>terraform validate</code>) the root testing harness (<code>lab04/main.tf</code>). These steps <strong>do not</strong> need AWS credentials.</p>
</li>
<li>
<p>Add a step named <code>Init Module for Testing</code> that changes the working directory to the module (<code>./lab04/modules/sqs-secure</code>) and runs <code>terraform init</code>. <strong>Crucially</strong>, add an <code>env:</code> block to this step to expose the <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> secrets you created, and also set <code>AWS_DEFAULT_REGION</code> to <code>us-west-2</code>.</p>
</li>
<li>
<p>Add a step named <code>Terraform Test Module</code> that runs <code>terraform test</code> from the module&#8217;s working directory (<code>./lab04/modules/sqs-secure</code>). This step <strong>also</strong> needs the same <code>env:</code> block as the previous step to provide AWS credentials for the <code>apply</code> actions within the tests.</p>
</li>
<li>
<p>Add steps to install Checkov (<code>pip install checkov</code>).</p>
</li>
<li>
<p>Add a step to run Checkov against the module directory (<code>checkov -d ./modules/sqs-secure --quiet</code>, ensure the <code>working-directory</code> is appropriate, e.g., <code>./lab04</code>).</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<p>Solution:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="yaml" class="yaml language-yaml"><span class="na">name</span><span class="pi">:</span> <span class="s">Module CI Checks (Lab 4)</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="c1"># Run on pushes to main branch</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">main</span>
  <span class="c1"># Run on pull requests targeting main branch</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">main</span>
  <span class="c1"># Allows manual triggering from GitHub UI</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">test</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Lint, Validate, Test, Scan</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout Code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup Terraform</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">hashicorp/setup-terraform@v3</span>
        <span class="c1"># with:</span>
        <span class="c1">#   terraform_version: "1.7.x" # Optional: Pin version</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Terraform Format Check (Recursive)</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./lab04</span> <span class="c1"># Run from lab04 dir</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">terraform fmt -check -recursive</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Terraform Init (for Root Validate)</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./lab04</span> <span class="c1"># Run from lab04 dir</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">terraform init</span> <span class="c1"># Needed for validate</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Terraform Validate (Root Harness)</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./lab04</span> <span class="c1"># Run from lab04 dir</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">terraform validate</span> <span class="c1"># Checks if lab04/main.tf is valid</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Init Module for Testing</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./lab04/modules/sqs-secure</span> <span class="c1"># Go into module dir</span>
        <span class="na">env</span><span class="pi">:</span> <span class="c1"># Add AWS credentials and region for test apply steps</span>
          <span class="na">AWS_ACCESS_KEY_ID</span><span class="pi">:</span> <span class="s">${{ secrets.AWS_ACCESS_KEY_ID }}</span>
          <span class="na">AWS_SECRET_ACCESS_KEY</span><span class="pi">:</span> <span class="s">${{ secrets.AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">AWS_DEFAULT_REGION</span><span class="pi">:</span> <span class="s2">"</span><span class="s">us-west-2"</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">terraform init</span> <span class="c1"># Initialize providers needed for tests</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Terraform Test Module</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./lab04/modules/sqs-secure</span> <span class="c1"># Run test from module dir</span>
        <span class="na">env</span><span class="pi">:</span> <span class="c1"># Add AWS credentials and region for test apply steps</span>
          <span class="na">AWS_ACCESS_KEY_ID</span><span class="pi">:</span> <span class="s">${{ secrets.AWS_ACCESS_KEY_ID }}</span>
          <span class="na">AWS_SECRET_ACCESS_KEY</span><span class="pi">:</span> <span class="s">${{ secrets.AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">AWS_DEFAULT_REGION</span><span class="pi">:</span> <span class="s2">"</span><span class="s">us-west-2"</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">terraform test</span> <span class="c1"># Runs tests found in ./tests/</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install Checkov</span>
        <span class="c1"># Run pip install globally or in a virtual env</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">pip install checkov</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run Checkov Scan</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./lab04</span> <span class="c1"># Define where checkov runs FROM</span>
        <span class="c1"># Point checkov specifically to the module directory</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">checkov -d ./modules/sqs-secure --quiet</span></code></pre>
</div>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_commit_workflow_file">4.5.4. Commit Workflow File</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Stage and commit the new workflow file from the repository root:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the ROOT of your repository</span>
git add .github/workflows/module-ci.yml
git commit <span class="nt">-m</span> <span class="s2">"ci: Add GitHub Actions workflow for module checks"</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_push_changes">4.5.5. Push Changes</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Push your commits (module code + workflow) to your remote GitHub repository (your fork):</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell">git push origin main</code></pre>
</div>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_verification_5">4.5.6. Verification</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the <strong>Actions</strong> tab in your GitHub repository fork.</p>
</li>
<li>
<p>Observe the "Module CI Checks (Lab 4)" workflow run.</p>
</li>
<li>
<p>There is a chance the run has failed at the lint "Terraform Format Check (Recursive)" step. If so, go back to the terminal and navigate to the <code>lab04</code> directory. Run <code>terraform fmt -recursive</code> to automatically fix any formatting issues. Afterwards, stage all file changes in the <code>lab04</code> directory, commit and push and visit the workflow page again.  To stage changes in the <code>lab04</code> directory, run:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the ROOT of your repository</span>
git add lab04
git commit <span class="nt">-m</span> <span class="s2">"fix(lab04): Resolve Terraform format issues"</span>
git push origin main</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Lint (Terraform Format Check), Init, Validate, and Test (But not Checkov Scan) steps pass successfully. The workflow typically takes a few minutes to complete. Troubleshoot the workflow YAML if any of these steps fail. **Note: If you notice the workflow fails at the</p>
</li>
<li>
<p><strong>Expect the <code>Run Checkov Scan</code> step to FAIL.</strong> Checkov should identify issues, most notably <code>CKV2_AWS_64</code> related to the KMS key missing an explicit policy. This is <strong>expected behavior</strong> for our current module code and demonstrates the value of security scanning in CI. For the next step (publishing), we want a green pipeline, so we will adjust the scan command.</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_adjusting_ci_for_known_findings">4.5.7. Adjusting CI for Known Findings</h4>
    
  </header>
  <p>Since our primary goal in this lab is to demonstrate the CI/CD and publishing workflow, and fixing the KMS policy is outside our current scope, let&#8217;s adjust the Checkov command to skip the known failure (<code>CKV2_AWS_64</code>) so the pipeline passes. In a real-world scenario, you would typically fix the underlying code or formally accept the risk.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Edit Workflow File:</strong> Open <code>.github/workflows/module-ci.yml</code> again.</p>
</li>
<li>
<p><strong>Modify Checkov Step:</strong> Locate the <code>Run Checkov Scan</code> step. Modify the <code>run:</code> command to add the <code>--skip-check CKV2_AWS_64</code> flag. Here is the updated <code>Run Checkov Scan</code> step:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="yaml" class="yaml language-yaml">      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run Checkov Scan</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./lab04</span> <span class="c1"># Define where checkov runs FROM</span>
        <span class="c1"># Point checkov specifically to the module directory</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">checkov -d ./modules/sqs-secure --quiet --skip-check CKV2_AWS_64</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Commit and Push Change:</strong> Stage, commit, and push this change to your <code>main</code> branch.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the ROOT of your repository</span>
git add .github/workflows/module-ci.yml
git commit <span class="nt">-m</span> <span class="s2">"ci: Skip CKV2_AWS_64 check for lab purposes"</span>
git push origin main</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Verify Green Pipeline:</strong> Go back to the <strong>Actions</strong> tab in GitHub. Observe the new workflow run triggered by your push. Verify that <strong>all</strong> steps, including the Checkov scan (which now skips the failing check), complete successfully (green checkmarks).</p>
</li>
</ol>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_version_and_publish_via_dedicated_repository">4.6. Version and Publish via Dedicated Repository</h3>
    
  </header>
  <p>Now that we&#8217;ve built, tested, and set up CI for our module locally, let&#8217;s prepare it for sharing by publishing it from a dedicated, correctly named repository that adheres to Terraform Registry conventions. We will use a pre-built repository containing the completed module code.</p>

<section class="sect3">
  <header>
    <h4 id="_fork_the_dedicated_module_repository">4.6.1. Fork the Dedicated Module Repository</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Navigate to Provided Repository:</strong> Open your web browser and go to the following URL (this repository contains the completed <code>sqs-secure</code> module code):
<code><a href="https://github.com/InfraCodeOps/terraform-aws-sqs-secure.git" class="bare">https://github.com/InfraCodeOps/terraform-aws-sqs-secure.git</a></code></p>
</li>
<li>
<p><strong>Fork the Repository:</strong> Click the <strong>Fork</strong> button in the upper-right corner. Select your personal GitHub account as the destination for the fork. This creates <code>YourUsername/terraform-aws-sqs-secure</code>.</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_create_version_tag_via_github_release">4.6.2. Create Version Tag via GitHub Release</h4>
    
  </header>
  <p>We will create the version tag directly using GitHub&#8217;s Release feature in your newly forked repository.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Go to Your Fork:</strong> Navigate to the main page of <strong>your forked</strong> repository (<code>YourUsername/terraform-aws-sqs-secure</code>) on GitHub.</p>
</li>
<li>
<p><strong>Create Release:</strong> Find the <strong>Releases</strong> section on the right-hand side (usually below "About"). Click <strong>Create a new release</strong>.</p>
</li>
<li>
<p><strong>Set Tag Version:</strong> Click "Choose a tag" dropdown and type <code>v1.0.0</code>. Click the option <strong>Create new tag: v1.0.0 on publish</strong>.</p>
</li>
<li>
<p><strong>Set Release Title:</strong> Enter a title, for example: <code>v1.0.0 Initial Release</code>.</p>
</li>
<li>
<p><strong>Publish Release:</strong> Scroll down and click the <strong>Publish release</strong> button. This action creates the <code>v1.0.0</code> Git tag in your forked repository.</p>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_publish_module_manually_via_hcp_ui">4.6.3. Publish Module Manually via HCP UI</h4>
    
  </header>
  <p>Since automatic discovery can sometimes be slow or affected by permissions caching, we will explicitly tell HCP Terraform where to find our newly tagged module.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Navigate to Registry:</strong> In the HCP Terraform UI, go to your organization and select <strong>Registry</strong> from the left-hand navigation.</p>
</li>
<li>
<p><strong>Publish Module:</strong> Click the <strong>Publish</strong> button (usually near the top right) and select <strong>Module</strong>.</p>
</li>
<li>
<p><strong>Select VCS &amp; Repository:</strong> Choose <strong>GitHub App</strong> (or your VCS provider). Find and select your newly forked repository: <code>terraform-aws-sqs-secure</code>.</p>
</li>
<li>
<p>Ensure publishing type is set to <strong>Tag</strong> and click <strong>Publish Module</strong></p>
</li>
<li>
<p>After a few moments, you see the published module&#8217;s landing page. Notice that it&#8217;s called <code>sqs-secure</code> and has version <code>1.0.0</code></p>
</li>
<li>
<p>Take note of the usage instructions, especially the source path and version constraints.</p>
</li>
</ol>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_troubleshooting_4">4.7. Troubleshooting</h3>
    
  </header>
  

<div class="ulist">
<ul>
<li>
<strong>CI Workflow Fails:</strong> Check the GitHub Actions logs for detailed errors. Common issues include incorrect paths in <code>working-directory</code>, syntax errors in the YAML, missing tool installations (Terraform, Checkov), or legitimate failures in <code>fmt</code>/<code>validate</code>/<code>test</code>/<code>checkov</code>.

</li>

</ul>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_review_4">4.8. Review</h3>
    
  </header>
  <p>In this lab, you successfully:
*   Created a GitHub Actions workflow to automate linting, validation, testing, and security scanning for your module.
*   Versioned your module code using a Git tag following Semantic Versioning.
*   Forked and published a module repository to the HCP Terraform Private Module Registry.</p>
</section>
</section>
      
        
<section class="sect1">
  <header>
    <h2 id="_lab_deploying_environments_managing_state">Lab: Deploying Environments &amp; Managing State</h2>
    
      <p class="subtitle">Module 5</p>
    
  </header>
  <div class="openblock objectives">
<div class="content">


<div class="ulist">
<ul>
<li>
Configure separate environments using HCP Workspaces

</li>

<li>
Implement environment-specific configuration with shared modules

</li>

<li>
Organize infrastructure with a structured directory layout

</li>

<li>
Trigger deployments through VCS workflow and CLI commands

</li>

<li>
Manage configuration drift

</li>

</ul>
</div>
</div>
</div>
<p>Estimated Time: 75-90 minutes</p>

<section class="sect2">
  <header>
    <h3 id="_prerequisites_and_setup_4">5.1. Prerequisites and Setup</h3>
    
  </header>
  

<div class="ulist">
<ul>
<li>
<strong>Accounts:</strong> HCP Terraform account, GitHub account. AWS Provider credentials configured locally AND set as sensitive variables in your initial HCP Workspace (<code>lab01</code> from Lab 1 - we&#8217;ll reuse these or copy them).

</li>

<li>
<strong>Tools:</strong> Terraform CLI (v1.6.0+), Git, Code Editor, AWS CLI.

</li>

<li>
<strong>Repository:</strong> Working within your clone of the <code>wa3581-starter</code> repository.

</li>

<li>
<strong>Previous State:</strong> Lab 4 successfully completed. Your <code>sqs-secure</code> module (version <code>v1.0.0</code>) should be published in your HCP Private Module Registry. Your <code>lab01</code> workspace exists in HCP.

</li>

<li>
<strong>Verification:</strong> Navigate to the root of your repository clone. Run <code>terraform --version</code>, <code>git status</code>, <code>aws sts get-caller-identity --region us-west-2</code>. Log into HCP Terraform UI and verify your module exists in the registry.

</li>

</ul>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_lab_scenario_managing_multiple_environments">5.2. Lab Scenario: Managing Multiple Environments</h3>
    
  </header>
  <p>In previous labs, we built, tested, and published a reusable module. Now, we need to use this module to deploy actual infrastructure for different environments, like 'development' (dev) and 'production' (prod). These environments often need similar infrastructure patterns (defined by our module) but require different configurations (e.g., naming, tags, perhaps instance sizes - though our module doesn&#8217;t vary size).</p>
<p>Crucially, we must keep the <strong>state</strong> for dev and prod completely separate. A mistake in dev should never impact prod.</p>
<p>This lab focuses on:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>HCP Workspaces for Isolation:</strong> Creating separate HCP Workspaces (<code>dev-sqs</code>, <code>prod-sqs</code>) to manage the state and configuration for each environment independently.</p>
</li>
<li>
<p><strong>Directory Structure:</strong> Organizing our Terraform code within the <code>lab05</code> directory using subdirectories (<code>dev/</code>, <code>prod/</code>) to hold the environment-specific configurations that call our shared module.</p>
</li>
<li>
<p><strong>Registry Consumption:</strong> Calling the <strong>same</strong> published module from the HCP Private Registry in both <code>dev/main.tf</code> and <code>prod/main.tf</code>, but providing different input variable values suitable for each environment.</p>
</li>
<li>
<p><strong>State Inspection:</strong> Using Terraform CLI commands connected to an HCP workspace to inspect the managed state.</p>
</li>
<li>
<p><strong>Drift Management:</strong> Simulating a manual change in AWS and using Terraform (connected to the correct workspace) to detect and correct this configuration drift, ensuring our code remains the source of truth.</p>
</li>
</ol>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_create_environment_directories">5.3. Create Environment Directories</h3>
    
  </header>
  <p>Let&#8217;s set up the local directory structure for our 'dev' and 'prod' configurations within the <code>lab05</code> directory.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From the root of your repository, create the directories and empty files:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the ROOT of your repository</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> lab05/dev
<span class="nb">mkdir</span> <span class="nt">-p</span> lab05/prod
<span class="nb">touch </span>lab05/dev/main.tf
<span class="nb">touch </span>lab05/prod/main.tf</code></pre>
</div>
</div>
</li>
</ol>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_create_and_configure_hcp_workspaces">5.4. Create and Configure HCP Workspaces</h3>
    
  </header>
  <p>We need two new HCP Workspaces, one for each environment.</p>

<section class="sect3">
  <header>
    <h4 id="_create_dev_sqs_workspace">5.4.1. Create 'dev-sqs' Workspace</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to your HCP Terraform organization UI.</p>
</li>
<li>
<p>Create a <strong>New workspace</strong>. If asked for a project, select <code>Default Project</code></p>
</li>
<li>
<p>Choose the <strong>Version control workflow</strong>.</p>
</li>
<li>
<p>Select your preconfigured <strong>GitHub App</strong> VCS provider.</p>
</li>
<li>
<p>Select <code>wa3581-starter</code> repository.</p>
</li>
<li>
<p>Configure Workspace Settings:</p>


<div class="ulist">
<ul>
<li>
<strong>Workspace Name:</strong> <code>dev-sqs</code>

</li>

<li>
Expand <code>Advanced Options</code>.

</li>

<li>
<strong>Terraform Working Directory:</strong> <code>lab05/dev</code> (Points to the dev config directory)

</li>

<li>
<strong>VCS Branch:</strong> <code>main</code> (or your default branch)

</li>

<li>
<strong>Apply Method:</strong> Check box for <code>Auto-apply API, CLI, &amp; VCS runs</code> (We&#8217;ll allow automatic applies for dev)

</li>

<li>
Under <strong>Automatic Run triggering</strong>, select <code>Only trigger runs when files in specified paths change</code>.

</li>

<li>
With <code>Patterns</code> selected, add <code>lab05/dev/**</code> as a pattern (make sure to click the <code>Add pattern</code> button after specifying path).

</li>

</ul>
</div>
</li>
<li>
<p>Click <strong>Create</strong> to create workspace.</p>
</li>
<li>
<p><strong>Set Variables:</strong> Navigate to the <code>dev-sqs</code> workspace <strong>Variables</strong> section.</p>


<div class="ulist">
<ul>
<li>
Under <strong>Workspace Variables</strong>, add:

</li>

<li>
Key: <code>queue_prefix</code>, category: <code>Terraform Variable</code>,  Value: <code>adv-tf-lab05-dev</code>, Not Sensitive.

</li>

<li>
Key: <code>environment_tag</code>, category: <code>Terraform Variable</code>, Value: <code>development</code>, Not Sensitive.

</li>

</ul>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_create_prod_sqs_workspace">5.4.2. Create 'prod-sqs' Workspace</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Repeat the process to create another workspace:</p>
</li>
<li>
<p>Navigate to your HCP Terraform organization UI.</p>
</li>
<li>
<p>Create a <strong>New workspace</strong>. If asked for a project, select <code>Default Project</code></p>
</li>
<li>
<p>Choose the <strong>Version control workflow</strong>.</p>
</li>
<li>
<p>Select your preconfigured <strong>GitHub App</strong> VCS provider.</p>
</li>
<li>
<p>Select <code>wa3581-starter</code> repository.</p>
</li>
<li>
<p>Configure Workspace Settings:</p>


<div class="ulist">
<ul>
<li>
<strong>Workspace Name:</strong> <code>prod-sqs</code>

</li>

<li>
Expand <code>Advanced Options</code>.

</li>

<li>
<strong>Terraform Working Directory:</strong> <code>lab05/prod</code> (Points to the prod config directory)

</li>

<li>
<strong>VCS Branch:</strong> <code>main</code> (or your default branch)

</li>

<li>
<strong>Apply Method:</strong> Leave both options unchecked. For production, we will manually apply.

</li>

<li>
Under <strong>Automatic Run triggering</strong>, select <code>Only trigger runs when files in specified paths change</code>.

</li>

<li>
With <code>Patterns</code> selected, add <code>lab05/prod/**</code> as a pattern (make sure to click the <code>Add pattern</code> button after specifying path).

</li>

</ul>
</div>
</li>
<li>
<p>Click <strong>Create</strong> to create workspace.</p>
</li>
<li>
<p><strong>Set Variables:</strong> Navigate to the <code>prod-sqs</code> workspace <strong>Variables</strong> section.</p>


<div class="ulist">
<ul>
<li>
Under <strong>Terraform Variables</strong>, add:

</li>

<li>
Key: <code>queue_prefix</code>, category: <code>Terraform Variable</code>,  Value: <code>adv-tf-lab05-prod</code>, Not Sensitive.

</li>

<li>
Key: <code>environment_tag</code>, category: <code>Terraform Variable</code>, Value: <code>production</code>, Not Sensitive.

</li>

</ul>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_verification_6">5.4.3. Verification</h4>
    
  </header>
  <p>You should now have two new HCP Workspaces, <code>dev-sqs</code> and <code>prod-sqs</code>, each configured to monitor a different subdirectory (<code>lab05/dev</code> and <code>lab05/prod</code>) in your repository and using different Terraform variable values.</p>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_define_environment_configurations">5.5. Define Environment Configurations</h3>
    
  </header>
  <p>Now, let&#8217;s write the Terraform code within our <code>dev</code> and <code>prod</code> directories, calling the module from the registry.</p>

<section class="sect3">
  <header>
    <h4 id="_configure_devmain_tf">5.5.1. Configure <code>dev/main.tf</code></h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Open <code>lab05/dev/main.tf</code> in your code editor.</p>
</li>
<li>
<p>Add the following configuration.
Challenge:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set up the <code>terraform</code> block with the <code>aws</code> and <code>random</code> required providers.</p>
</li>
<li>
<p>Declare input variables <code>queue_prefix</code> and <code>environment_tag</code> (these will be populated by the HCP Workspace variables).</p>
</li>
<li>
<p>Call the <code>sqs-secure</code> module (using its registry source from Lab 4 - remember to replace <code>&lt;YOUR_ORG_NAME&gt;</code>) named <code>dev_queue</code>.</p>
</li>
<li>
<p>Pass the <code>var.queue_prefix</code> to the module&#8217;s <code>queue_name_prefix</code> input.</p>
</li>
<li>
<p>Set the module&#8217;s <code>tags</code> input to include a common tag (<code>Project = "Advanced TF Course"</code>) and an environment-specific tag using <code>var.environment_tag</code>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<p>Solution:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">terraform</span> <span class="p">{</span>
  <span class="nx">required_providers</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/aws"</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 5.0"</span>
    <span class="p">}</span>
    <span class="nx">random</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/random"</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 3.1"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1"># Backend configured by HCP Workspace</span>
<span class="p">}</span>

<span class="c1"># Variables will be populated by HCP Workspace Variables</span>
<span class="nx">variable</span> <span class="s2">"queue_prefix"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Prefix for queue names, provided by workspace."</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"environment_tag"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Tag value for the Environment tag, provided by workspace."</span>
<span class="p">}</span>

<span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="o">=</span> <span class="s2">"us-west-2"</span>
<span class="p">}</span>

<span class="nx">module</span> <span class="s2">"dev_queue"</span> <span class="p">{</span>
  <span class="c1"># Replace &lt;YOUR_ORG_NAME&gt; with your HCP Org Name</span>
  <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"app.terraform.io/&lt;YOUR_ORG_NAME&gt;/sqs-secure/aws"</span>
  <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 1.0.0"</span> <span class="c1"># Use constraint matching published version</span>

  <span class="nx">queue_name_prefix</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">queue_prefix</span> <span class="c1"># From workspace variable</span>
  <span class="nx">enable_dlq</span>        <span class="o">=</span> <span class="kc">true</span>             <span class="c1"># Keep DLQ enabled for dev</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Project</span>     <span class="o">=</span> <span class="s2">"Advanced TF Course"</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment_tag</span> <span class="c1"># From workspace variable</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Optional: Define outputs if needed for cross-workspace dependencies later</span>
<span class="c1"># output "dev_queue_arn" { value = module.dev_queue.main_queue_arn }</span></code></pre>
</div>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_configure_prodmain_tf">5.5.2. Configure <code>prod/main.tf</code></h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Open <code>lab05/prod/main.tf</code> in your code editor.</p>
</li>
<li>
<p>Add very similar configuration, but potentially adjust module inputs if needed for prod (though for this lab, we&#8217;ll keep them functionally the same besides prefixes/tags).
Challenge: Add the necessary <code>terraform</code>, <code>variable</code>, <code>provider</code>, and <code>module</code> blocks, ensuring you use <code>var.queue_prefix</code> and <code>var.environment_tag</code> correctly. Name the module call <code>prod_queue</code>.</p>
</li>
</ol>
</div>
<p>Solution:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="hcl" class="hcl language-hcl"><span class="nx">terraform</span> <span class="p">{</span>
  <span class="nx">required_providers</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/aws"</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 5.0"</span>
    <span class="p">}</span>
    <span class="nx">random</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/random"</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 3.1"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1"># Backend configured by HCP Workspace</span>
<span class="p">}</span>

<span class="c1"># Variables will be populated by HCP Workspace Variables</span>
<span class="nx">variable</span> <span class="s2">"queue_prefix"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Prefix for queue names, provided by workspace."</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"environment_tag"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Tag value for the Environment tag, provided by workspace."</span>
<span class="p">}</span>

<span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="o">=</span> <span class="s2">"us-west-2"</span>
<span class="p">}</span>

<span class="nx">module</span> <span class="s2">"prod_queue"</span> <span class="p">{</span>
  <span class="c1"># Replace &lt;YOUR_ORG_NAME&gt; with your HCP Org Name</span>
  <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"app.terraform.io/&lt;YOUR_ORG_NAME&gt;/sqs-secure/aws"</span>
  <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 1.0.0"</span> <span class="c1"># Use constraint matching published version</span>

  <span class="nx">queue_name_prefix</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">queue_prefix</span> <span class="c1"># From workspace variable</span>
  <span class="nx">enable_dlq</span>        <span class="o">=</span> <span class="kc">true</span>             <span class="c1"># Keep DLQ enabled for prod</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Project</span>     <span class="o">=</span> <span class="s2">"Advanced TF Course"</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment_tag</span> <span class="c1"># From workspace variable</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Optional: Define outputs if needed</span>
<span class="c1"># output "prod_queue_arn" { value = module.prod_queue.main_queue_arn }</span></code></pre>
</div>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_trigger_environment_deployments">5.6. Trigger Environment Deployments</h3>
    
  </header>
  <p>Now commit and push the code for both environments to trigger runs in their respective workspaces.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Stage and Commit:</strong> From the root of your repository, stage and commit the new <code>dev</code> and <code>prod</code> configurations.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell"><span class="c"># Ensure you are in the ROOT of your repository</span>
git add lab05/dev/main.tf lab05/prod/main.tf
git commit <span class="nt">-m</span> <span class="s2">"feat(lab05): Configure dev and prod SQS environments"</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Push Changes:</strong> Push the commit to your remote GitHub repository.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code data-lang="shell" class="shell language-shell">git push origin main</code></pre>
</div>
</div>
</li>
</ol>
</div>

<section class="sect3">
  <header>
    <h4 id="_trigger_initial_hcp_runs">5.6.1. Trigger Initial HCP Runs</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Since workspaces require an manual initial run trigger, do so for both workspaces. Ensure you choose the <code>Plan and apply</code> run type for both.</p>
</li>
<li>
<p>Trigger a run in the <code>dev-sqs</code> workspace.</p>
</li>
<li>
<p>Trigger a run in the <code>prod-sqs</code> workspace.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>For <code>prod-sqs</code> you will need to manually select <code>Confirm and apply</code> on the run page.</p>
</li>
<li>
<p>This is because <code>prod-sqs</code> is configured to manually apply.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</section>

<section class="sect3">
  <header>
    <h4 id="_verification_7">5.6.2. Verification</h4>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>Verify that the runs in both <code>dev-sqs</code> and <code>prod-sqs</code> workspaces complete successfully.</p>
</li>
<li>
<p>Check the <strong>States</strong> tab for each workspace to see the managed resources (KMS key, SQS queues).</p>
</li>
<li>
<p>(Optional) Verify in the AWS Console (<code>us-west-2</code>) that two sets of queues/keys exist with names matching the <code>dev</code> and <code>prod</code> prefixes.</p>
</li>
</ol>
</div>
</section>
</section>

<section class="sect2">
  <header>
    <h3 id="_cleanup_4">5.7. Cleanup</h3>
    
  </header>
  <div class="olist arabic">
<ol class="arabic">
<li>
<p>For each workspace (<code>dev-sqs</code>, <code>prod-sqs</code>) in the HCP UI:</p>
</li>
<li>
<p>Navigate to <strong>Settings &#8594; Destruction and Deletion</strong>.</p>
</li>
<li>
<p>Click <strong>Queue destroy plan</strong>. Enter workspace name to confirm.</p>
</li>
<li>
<p>For <code>prod-sqs</code>, navigate to the Run page and <strong>Confirm &amp; Apply</strong> the destruction plan.</p>
</li>
</ol>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_troubleshooting_5">5.8. Troubleshooting</h3>
    
  </header>
  

<div class="ulist">
<ul>
<li>
<strong>Workspace Creation Errors:</strong> Check for naming conflicts if workspaces already exist. Verify VCS connection permissions.

</li>

<li>
<strong>Variable Errors:</strong> Ensure Terraform and Environment variables (especially AWS creds) are correctly set <strong>in each workspace</strong> (<code>dev-sqs</code>, <code>prod-sqs</code>) and marked sensitive where needed. Check for typos in variable keys.

</li>

<li>
<strong>HCP Run Failures:</strong> Examine the detailed run logs in the HCP UI for specific Terraform errors (provider issues, API limits, permission errors).

</li>

</ul>
</div>
</section>

<section class="sect2">
  <header>
    <h3 id="_review_5">5.9. Review</h3>
    
  </header>
  <p>In this lab, you successfully:</p>


<div class="ulist">
<ul>
<li>
Created and configured separate HCP Workspaces (<code>dev-sqs</code>, <code>prod-sqs</code>) for environment isolation.

</li>

<li>
Structured environment-specific code in <code>dev/</code> and <code>prod/</code> directories.

</li>

<li>
Used a published module from the HCP Private Registry in multiple environments with different configurations.

</li>

<li>
Triggered environment deployments via the VCS workflow.

</li>

<li>
Inspected state for both workspaces in the HCP UI.

</li>

</ul>
</div>
</section>
</section>
      
        
<section class="sect1">
  <header>
    <h2 id="_class_activity_collaborative_gitops_workflow_exploration">Class Activity: Collaborative GitOps Workflow Exploration</h2>
    
      <p class="subtitle">Module 6</p>
    
  </header>
  <p>In this activity, you will participate in an <strong>instructor-led coding and discussion experience</strong> focused on implementing a GitOps workflow with HCP Terraform. Unlike previous labs where you worked independently, this session is designed for interaction.</p>
<p>The instructor will guide the setup of a simple Terraform configuration and a connected HCP Workspace. Together, we will explore the Pull Request lifecycle for infrastructure changes:</p>


<div class="ulist">
<ul>
<li>
Proposing changes via feature branches and PRs.

</li>

<li>
Observing automated <code>plan</code> feedback within HCP Terraform.

</li>

<li>
Discussing the review process and merge strategies.

</li>

<li>
Witnessing the automated <code>apply</code> based on workspace settings.

</li>

</ul>
</div>
<p>This collaborative format allows us to improvise, discuss variations, and ensure everyone understands the core principles and mechanics of managing Terraform changes safely through a GitOps approach. Your active participation is encouraged!</p>
</section>
      
        
<section class="sect1">
  <header>
    <h2 id="_class_activity_collaborative_security_compliance_workflow_showcase">Class Activity: Collaborative Security, Compliance &amp; Workflow Showcase</h2>
    
      <p class="subtitle">Module 7</p>
    
  </header>
  <p>This activity is an <strong>instructor-led configuration and discussion experience</strong> exploring the critical aspects of securing Terraform workflows and enhancing collaboration, as covered in Chapter 7. Moving beyond individual coding, we&#8217;ll collaboratively examine features and strategies.</p>
<p>The instructor will guide a showcase and discussion covering a range of topics, potentially including demonstrations of:</p>


<div class="ulist">
<ul>
<li>
<strong>Securing the Workflow:</strong> Implementing least privilege (IAM, HCP Permissions), managing sensitive data securely (HCP Sensitive Variables vs. other methods), and protecting state.

</li>

<li>
<strong>Automated Guardrails:</strong> Understanding different policy enforcement points (Static Analysis, Plan Analysis) and seeing tools like Checkov in action to catch misconfigurations proactively. Discussing concepts like Sentinel or OPA.

</li>

<li>
<strong>Standardization &amp; Collaboration:</strong> Leveraging platform features like HCP Variable Sets for consistency and configuring Teams for Role-Based Access Control.

</li>

<li>
<strong>Integrating Checks:</strong> Discussing how security and compliance tools fit into CI/CD pipelines and HCP Run Tasks.

</li>

</ul>
</div>
<p>The purpose of this session is to discuss and analyze how to build more secure, compliant, and collaborative Terraform practices.</p>
</section>
      
        
<section class="sect1">
  <header>
    <h2 id="_class_activity_collaborative_refactoring_analysis">Class Activity: Collaborative Refactoring Analysis</h2>
    
      <p class="subtitle">Module 8</p>
    
  </header>
  <p>This final activity is an <strong>interactive group code review and discussion</strong> focused on synthesizing the best practices learned throughout the workshop. We shift from building new things to critically evaluating an existing (intentionally flawed) Terraform configuration.</p>
<p>The instructor will present a sample Terraform project exhibiting common anti-patterns. As a group, we will:</p>


<div class="ulist">
<ul>
<li>
<strong>Analyze the Code:</strong> Collectively identify areas that violate principles of good module design, state management, security, testing, and workflow automation.

</li>

<li>
<strong>Discuss Improvements:</strong> Brainstorm and propose concrete refactoring steps based on the advanced techniques covered in this course.

</li>

<li>
<strong>Articulate Benefits:</strong> Discuss <strong>why</strong> the proposed changes lead to more maintainable, scalable, secure, and reliable infrastructure management.

</li>

</ul>
</div>
<p>This session relies on your active participation to apply your accumulated knowledge in a discussion. Your insights and questions are encouraged and will help solidify the learning experience.</p>
</section>
      

      <div class="footnotes">
        
      </div>
    </main>
  </div>
  <footer class="document-footer">
    <section class="colophon container">
      <p>© 2025 Ascendient, LLC</p>
<p>Revision 1.0.1 published on 2025-04-16.</p>
<p>No part of this book may be reproduced or used in any form or by any electronic, mechanical, or other means, currently available or developed in the future, including photocopying, recording, digital scanning, or sharing, or in any information storage or retrieval system, without permission in writing from the publisher.</p>
<p><strong>Trademark Notice:</strong> Product or corporate names may be trademarks or registered trademarks, and are used only for identification and explanation without intent to infringe.</p>
<p>To obtain authorization for any such activities (e.g., reprint rights, translation rights), to customize this book, or for other sales inquiries, please contact:</p>
<p>Ascendient, LLC<br>
1 California Street Suite 2900<br>
San Francisco, CA 94111<br>
<a href="https://www.ascendientlearning.com/" class="bare">https://www.ascendientlearning.com/</a></p>
<p>USA: 1-877-517-6540, email: <a href="mailto:getinfousa@ascendientlearning.com">getinfousa@ascendientlearning.com</a><br>
Canada: 1-877-812-8887 toll free, email: <a href="mailto:getinfo@ascendientlearning.com">getinfo@ascendientlearning.com</a></p>
    </section>
  </footer>
  <script type="module">
    /* Code for Syntax Highlighting with Shiki */
    /*
    import { codeToHtml } from 'https://esm.sh/shiki@1.0.0';

    const codeElements = document.querySelectorAll('pre.highlight code');

    codeElements.forEach(async (codeElement) => {
      codeElement.innerHTML = await codeToHtml(codeElement.textContent, {
        lang: codeElement.getAttribute('data-lang') || 'text', // Default to 'text' if no language is specified
        themes: {
          dark: 'github-dark',
          light: 'github-light'
        }
      });
    });
    */
  </script>
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', () => {
      const sidebarLinks = document.querySelectorAll('.document-sidebar nav ul li a');

      sidebarLinks.forEach(link => {
        const secondLevelList = link.nextElementSibling;

        if (secondLevelList && secondLevelList.tagName === 'UL') {
          link.parentElement.classList.add('closed');

          link.addEventListener('click', (event) => {
            event.preventDefault();
            link.parentElement.classList.toggle('closed');
          });
        }
      });

      function setActiveLink() {
        const anchors = document.querySelectorAll('ul.sectlevel1 li a');
        let current = "";

        document.querySelectorAll('header h1, header h2, header h3, header h4').forEach((section) => {
          if (pageYOffset + 0.66 * innerHeight >= section.offsetTop) {
          current = section.getAttribute("id");
          }
        });

        anchors.forEach(anchor => {
          const targetId = anchor.getAttribute('href').substring(1);
          const secondLevelList = anchor.nextElementSibling;


          var isActive = targetId === current;
          const parentActive = Array.from(anchor.parentElement.querySelectorAll('a')).some(a => a.getAttribute('href').substring(1) === current);
          anchor.classList.toggle('active', isActive);
          anchor.classList.toggle('parent-active', parentActive && !isActive);

          isActive = isActive || parentActive;

          anchor.parentElement.classList.toggle('closed', !isActive);

          if (isActive && secondLevelList && secondLevelList.tagName === 'UL') {
            secondLevelList.classList.remove('closed');
          }

          if (isActive) {
            document.querySelector('.sidebar-content').scrollTo({ top: anchor.offsetTop - document.querySelector('.sidebar-content').clientHeight / 2 });
          }
        });
      }

      window.addEventListener('DOMContentLoaded', setActiveLink);
      window.addEventListener('scroll', setActiveLink);
    });


    // Set the theme based on user's preference
    const userPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedTheme = localStorage.getItem('theme');
    const theme = savedTheme || (userPrefersDark ? 'dark' : 'light');
    document.body.setAttribute('data-theme', theme);

    // Save the theme preference
    function toggleTheme() {
      const body = document.body;
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }
    

    const sidebar = document.querySelector('.document-sidebar');
    function closeSidebar() {
      if (!sidebar.classList.contains('overlay')) {
        return;
      }

      sidebar.classList.remove('overlay');
    }


    function toggleSidebar() {
      sidebar.classList.toggle('overlay');
    }


    document.querySelector('.overlay-background').addEventListener('click', closeSidebar);

    document.querySelectorAll('.document-sidebar a').forEach(item => {
      item.addEventListener('click', closeSidebar);
    });
  </script>
</body>
</html>